<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos51 - Hamburguesas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #D32F2F; /* Red for main actions */
            --secondary: #3E2723; /* Dark brown for accents */
            --accent: #4CAF50; /* Green for success */
            --dark: #212121; /* Dark grey for footer */
            --light: #f3f4f6; /* Lighter Gray BG */
            --white: #ffffff;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--light);
            color: var(--text-dark);
            line-height: 1.6;
        }
        
        .header {
            background: var(--white);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-container {
            cursor: pointer;
            user-select: none;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-dark);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .logo-red {
            color: var(--secondary);
        }
        
        .logo-number {
            color: var(--primary);
        }
        
        .logo-subtitle {
            font-size: 0.5em;
            font-weight: 400;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--text-dark);
            display: block;
            margin-top: -8px;
        }
        
        .nav-links {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .nav-btn {
            color: var(--text-dark);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .nav-btn:hover {
            color: var(--primary);
        }
        
        .cart-btn {
            position: relative;
            background: var(--primary);
            color: var(--white);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .cart-btn:hover {
            transform: translateY(-2px);
            background: #b71c1c;
            box-shadow: 0 5px 20px rgba(211, 47, 47, 0.3);
        }
        
        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: var(--white);
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        .hero {
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            color: var(--white);
            padding: 8rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: 60vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1;
        }

        .hero-content {
            position: relative;
            z-index: 2;
            max-width: 700px;
        }
        
        .hero h1 {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            font-weight: 800;
        }
        
        .hero p {
            font-size: 1.3rem;
            opacity: 0.95;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }
        
        .category-filter {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .filter-btn {
            padding: 0.75rem 1.5rem;
            background: var(--white);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .filter-btn:hover, .filter-btn.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }
        
        .products-section {
            margin-bottom: 4rem;
        }
        
        .section-title {
            font-size: 2rem;
            margin-bottom: 2rem;
            color: var(--primary);
            font-weight: 700;
            text-align: center;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
        }
        
        .product-card {
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .product-image {
            width: 100%;
            height: 250px;
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            position: relative;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .product-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(239, 68, 68, 0.95);
            color: var(--white);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .product-info {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        
        .product-category {
            color: var(--secondary);
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        
        .product-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }
        
        .product-brand {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .product-description {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .product-stock {
            color: var(--warning);
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        
        .product-price {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        .add-to-cart-btn {
            width: 100%;
            background: var(--primary);
            color: var(--white);
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .add-to-cart-btn:hover {
            transform: translateY(-2px);
            background: var(--secondary);
            box-shadow: 0 5px 20px rgba(62, 39, 35, 0.3);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: var(--white);
            max-width: 800px;
            width: 95%;
            margin: 2rem auto;
            border-radius: 16px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }
        
        .modal-header {
            padding: 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--white);
            z-index: 10;
        }
        
        .modal-header h2 {
            font-size: 1.8rem;
            color: var(--primary);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-dark);
            line-height: 1;
        }
        
        .modal-body {
            padding: 2rem;
        }
        
        .cart-item {
            display: flex;
            gap: 1.5rem;
            padding: 1.5rem;
            background: var(--light);
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        
        .cart-item-icon {
            font-size: 3rem;
            flex-shrink: 0;
        }
        
        .cart-item-info {
            flex-grow: 1;
        }
        
        .cart-item-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-dark);
            margin-bottom: 0.3rem;
        }
        
        .cart-item-brand {
            color: #999;
            font-size: 0.85rem;
            margin-bottom: 0.3rem;
        }
        
        .cart-item-variants {
            font-size: 0.85rem;
            color: var(--text-light);
            background-color: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
            margin-top: 0.25rem;
        }

        .cart-item-price {
            color: var(--text-light);
            font-size: 0.95rem;
        }
        
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }
        
        .qty-btn {
            background: var(--white);
            border: 1px solid var(--border-color);
            color: var(--primary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
        }
        
        .qty-btn:hover {
            background: var(--primary);
            color: var(--white);
        }
        
        .qty-display {
            font-weight: 700;
            font-size: 1.1rem;
            min-width: 30px;
            text-align: center;
        }
        
        .remove-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: underline;
            margin-left: auto;
        }
        
        .cart-total {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--primary);
            color: var(--white);
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cart-total-label {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .cart-total-amount {
            font-size: 2rem;
            font-weight: 800;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--secondary);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-hint {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }
        
        .btn-primary {
            width: 100%;
            background: var(--primary);
            color: var(--white);
            padding: 1.2rem;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            background: #b71c1c;
            box-shadow: 0 8px 25px rgba(211, 47, 47, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            background: var(--primary); /* Keep color on disabled */
            box-shadow: none;
        }
        
        .btn-secondary {
            background: var(--white);
            border: 1px solid var(--border-color);
            color: var(--primary);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-secondary:hover {
            background: var(--primary);
            color: var(--white);
        }
        
        .btn-danger {
            background: var(--danger);
            color: var(--white);
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .empty-cart {
            text-align: center;
            padding: 3rem 2rem;
            color: #999;
        }
        
        .empty-cart-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
        }
        
        .success-message {
            display: none;
            text-align: center;
            padding: 3rem 2rem;
        }
        
        .success-icon {
            font-size: 5rem;
            color: var(--success);
            margin-bottom: 1rem;
        }
        
        .success-message h3 {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        .success-message p {
            color: var(--text-light);
            margin-bottom: 2rem;
        }
        
        .admin-section {
            background: var(--white);
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .admin-search-container {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-grow: 1;
        }
        
        .admin-search-container input {
            width: 100%;
            max-width: 400px;
        }

        .admin-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .admin-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
        }

        .admin-nav-btn {
            padding: 0.75rem 1.5rem;
            background: var(--light);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .admin-nav-btn.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }


        .btn-import {
            background: var(--accent);
            color: var(--white);
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .btn-import:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-export {
            background: #6366f1;
            color: var(--white);
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .btn-export:hover {
            background: #4f46e5;
            transform: translateY(-2px);
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .admin-table th, .admin-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .admin-table th {
            background: var(--light);
            font-weight: 700;
            color: var(--primary);
        }
        
        .admin-table tbody tr:hover {
            background: #f9fafb;
        }
        
        .admin-table tbody tr.clickable:hover {
            cursor: pointer;
        }

        .table-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn-edit {
            background: var(--secondary);
            color: var(--white);
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn-lotes {
            background: var(--primary);
            color: var(--white);
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }
        
        .footer {
            background: var(--dark);
            color: var(--white);
            text-align: center;
            padding: 2.5rem 2rem;
            margin-top: 4rem;
        }
        
        .footer-logo {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            color: var(--white);
        }
        
        .login-section {
            background: var(--white);
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            max-width: 500px;
            margin: 0 auto;
        }

        .auth-info {
            background: #f0f9ff;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--secondary);
        }

        .setup-steps, .sql-code {
             color: var(--text-light); font-size: 0.9rem;
        }

        .setup-steps li {
            margin-bottom: 0.5rem;
        }

        .sql-code {
            background: #eef2ff;
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
            margin-top: 1rem;
            border: 1px solid #e0e7ff;
            color: #4338ca;
        }
        
        .error-info {
            background: #fff1f2;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--danger);
        }

        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .kpi-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .kpi-card[onclick]:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            border-color: var(--secondary);
        }

        .kpi-card-title {
            font-size: 1rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .kpi-card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .status-select {
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid transparent;
            font-weight: 600;
            color: var(--white);
            text-transform: capitalize;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.2em;
            padding-right: 2.5em; /* space for the arrow */
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            cursor: pointer;
        }

        .status-select:focus {
            outline: 2px solid var(--white);
            outline-offset: -2px;
        }

        .status-select.pendiente_pago { background-color: var(--warning); }
        .status-select.pago_confirmado { background-color: var(--info); }
        .status-select.en_preparacion { background-color: var(--secondary); }
        .status-select.enviado { background-color: var(--primary); }
        .status-select.entregado { background-color: var(--success); }
        .status-select.cancelado { background-color: var(--danger); }

        #mapa {
            height: 450px;
            width: 100%;
            border-radius: 12px;
        }

        .pedidos-table tr.row-updated {
            animation: highlight-row 3s ease-out;
        }

        .variantes-container {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .variante-group {
            background: var(--light);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .variante-header {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }
        .variante-header input {
            flex-grow: 1;
        }
        .opciones-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            align-items: stretch;
        }
        .opciones-container input {
            border: none;
            padding: 0.5rem;
            background: transparent;
            width: 120px;
        }
        .opciones-container input:focus {
            outline: none;
        }
        
        .opcion-tag-enhanced {
            background: var(--white);
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .opcion-image-preview {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
        }
        .opcion-image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .opcion-image-preview:hover::after {
            content: 'üñºÔ∏è';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .opcion-details {
            flex-grow: 1;
        }
        .opcion-details span {
            font-weight: 500;
        }
        .opcion-tag-enhanced button {
            background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--danger); line-height: 1;
            padding: 0.2rem;
        }

        #detalleProductoModal .modal-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            max-width: 900px;
        }
        #detalleProductoModal .product-image-modal {
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            border-radius: 16px 0 0 16px;
        }
         #detalleProductoModal .product-image-modal img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #ayudaView .help-card {
            background: var(--white);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        #ayudaView h3 {
            color: var(--primary);
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 0.5rem;
            display: inline-block;
        }

        #ayudaView p, #ayudaView li {
            color: var(--text-light);
            margin-bottom: 0.75rem;
        }
        
        #ayudaView ul, #ayudaView ol {
            padding-left: 20px;
        }

        #ayudaView strong {
            color: var(--text-dark);
        }
        
        #ayudaView details {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 1rem;
        }
        #ayudaView summary {
            font-weight: 600;
            cursor: pointer;
            padding: 1rem;
            background: var(--light);
        }

        .variant-swatches {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--white);
            box-shadow: 0 0 0 1px var(--border-color);
            cursor: default;
            transition: transform 0.2s;
        }
        .color-swatch:hover {
            transform: scale(1.1);
        }

        .ingreso-stock-modal-content {
            max-width: 700px;
        }

        .lote-item {
            display: grid;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            border-radius: 8px;
            background-color: var(--light);
            margin-bottom: 0.5rem;
        }
        
        .lote-item > div {
            font-weight: 500;
        }

        .fecha-vencimiento.expirado {
            color: var(--danger);
            font-weight: 700;
        }
        .fecha-vencimiento.proximo-expirar {
            color: var(--warning);
            font-weight: 700;
        }
        
        .movimiento-tipo {
            font-weight: 600;
        }
        .movimiento-tipo.ingreso {
            color: var(--success);
        }
        .movimiento-tipo.salida {
            color: var(--danger);
        }

        @keyframes highlight-row {
            0% { background-color: #bfdbfe; }
            100% { background-color: transparent; }
        }
        
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2.5rem;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-links {
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            
            .modal-content {
                margin: 0;
                width: 100%;
                border-radius: 0;
                max-height: 100vh;
            }
            #detalleProductoModal .modal-content {
                grid-template-columns: 1fr;
            }
            #detalleProductoModal .product-image-modal {
                height: 300px;
                 border-radius: 0;
            }
            
            .logo-text {
                font-size: 1.2rem;
            }
            
            .admin-table {
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <nav class="nav-container">
            <div class="logo-container" onclick="mostrarTienda()">
                <div>
                    <div class="logo-text">
                        <span class="logo-red">Pedidos</span><span class="logo-number">51</span>
                    </div>
                    <span class="logo-subtitle">HAMBURGUESAS</span>
                </div>
            </div>
            <div class="nav-links">
                <button class="nav-btn" onclick="mostrarTienda()" id="btnTienda">Tienda</button>
                <button class="nav-btn" onclick="mostrarAdmin()" id="btnAdmin">Admin</button>
                <button class="cart-btn" onclick="abrirCarrito()">
                    Carrito
                    <span class="cart-count" id="cartCount">0</span>
                </button>
            </div>
        </nav>
    </header>

    <div id="tiendaView">
        <section class="hero" id="heroSection">
            <div class="hero-content">
                <h1>Hamburguesas que Dejan Huella</h1>
                <p>Las mejores hamburguesas artesanales, hechas con pasi√≥n y los ingredientes m√°s frescos.</p>
            </div>
        </section>

        <main class="container">
            <section class="products-section">
                <div class="category-filter" id="categoryFilter"></div>
                <h2 class="section-title">Nuestro Men√∫</h2>
                <div class="products-grid" id="productsGrid"></div>
                <div id="loadingProducts" class="loading" style="display:none;">Cargando men√∫...</div>
            </section>
        </main>
    </div>

    <div id="adminView" style="display:none;">
        <main class="container">
            <div id="loginSection" class="login-section">
                <h2 style="margin-bottom: 1rem; color: var(--primary);">Acceso Administrador</h2>
                <div class="auth-info">
                    <p style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 1rem;">
                        <strong>Para acceder, crea un usuario en Supabase:</strong>
                    </p>
                    <ol class="setup-steps">
                        <li>Ve a tu proyecto Supabase Dashboard ‚Üí Authentication ‚Üí Users</li>
                        <li>Click "Add user" ‚Üí "Create new user"</li>
                        <li>Ingresa email, contrase√±a y confirma el email.</li>
                    </ol>
                </div>
                <form id="loginForm" onsubmit="iniciarSesion(event)">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="emailLogin" required placeholder="admin@pedidos51.com">
                    </div>
                    <div class="form-group">
                        <label>Contrase√±a</label>
                        <input type="password" id="passwordLogin" required>
                    </div>
                    <button type="submit" class="btn-primary">Iniciar Sesion</button>
                    <div id="loginError" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none; background: #fee2e2; color: #b91c1c;"></div>
                </form>
            </div>

            <div id="adminPanel" style="display:none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <span id="adminEmail" style="color: var(--text-light); font-size: 0.9rem;"></span>
                    <button class="btn-danger" onclick="cerrarSesion()">Cerrar Sesion</button>
                </div>

                <div class="admin-nav">
                    <button class="admin-nav-btn active" id="navBtnPedidos" onclick="mostrarVistaAdmin('pedidos')">Pedidos</button>
                    <button class="admin-nav-btn" id="navBtnReportes" onclick="mostrarVistaAdmin('reportes')">Reportes</button>
                    <button class="admin-nav-btn" id="navBtnInventario" onclick="mostrarVistaAdmin('inventario')">Inventario</button>
                    <button class="admin-nav-btn" id="navBtnProductos" onclick="navegarAProductos()">Productos</button>
                    <button class="admin-nav-btn" id="navBtnCategorias" onclick="mostrarVistaAdmin('categorias')">Categor√≠as</button>
                    <button class="admin-nav-btn" id="navBtnConfig" onclick="mostrarVistaAdmin('config')">Configuraci√≥n</button>
                    <button class="admin-nav-btn" id="navBtnAyuda" onclick="mostrarVistaAdmin('ayuda')">Ayuda</button>
                </div>

                <div id="pedidosView" class="admin-view-content">
                    <div class="kpi-container">
                        <div class="kpi-card">
                            <div class="kpi-card-title">Ingresos Totales (Filtrados)</div>
                            <div class="kpi-card-value" id="kpiIngresos">S/ 0.00</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-card-title">Pedidos Totales</div>
                            <div class="kpi-card-value" id="kpiTotalPedidos">0</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-card-title">Pedidos Pendientes</div>
                            <div class="kpi-card-value" id="kpiPendientes">0</div>
                        </div>
                        <div class="kpi-card" id="kpiBajosStockPedidos" onclick="verProductosBajosStock()" style="cursor: pointer; border-left: 4px solid var(--warning);">
                            <div class="kpi-card-title">Productos Bajos de Stock</div>
                            <div class="kpi-card-value">0</div>
                        </div>
                    </div>
                     <div class="admin-section">
                        <div class="admin-header">
                            <h2>Historial de Pedidos</h2>
                        </div>
                        <div id="pedidosFilterContainer" class="category-filter"></div>
                        <div style="overflow-x: auto;">
                            <table class="admin-table pedidos-table">
                                <thead>
                                    <tr>
                                        <th>N¬∞ Pedido</th>
                                        <th>Fecha</th>
                                        <th>Cliente</th>
                                        <th>Total</th>
                                        <th>Estado</th>
                                        <th>Ubicaci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="adminPedidosTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="inventarioView" class="admin-view-content" style="display:none;">
                    <div id="inventarioDashboard">
                        <div class="kpi-container">
                            <div class="kpi-card" style="border-left: 4px solid var(--primary);">
                                <div class="kpi-card-title">Valor Total del Inventario</div>
                                <div class="kpi-card-value" id="kpiValorInventario">S/ 0.00</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-card-title">Unidades Totales en Stock</div>
                                <div class="kpi-card-value" id="kpiUnidadesTotales">0</div>
                            </div>
                            <div class="kpi-card" style="border-left: 4px solid var(--warning);">
                                <div class="kpi-card-title">Productos Bajos de Stock</div>
                                <div class="kpi-card-value" id="kpiBajosStockInventario">0</div>
                            </div>
                            <div class="kpi-card" style="border-left: 4px solid var(--danger);">
                                <div class="kpi-card-title">Productos Sin Stock</div>
                                <div class="kpi-card-value" id="kpiSinStock">0</div>
                            </div>
                        </div>
                        <div class="admin-section">
                            <div class="admin-header">
                                <h2>Estado del Inventario</h2>
                                <div class="admin-search-container">
                                    <input type="text" id="inventorySearchInput" placeholder="Buscar producto..." oninput="renderizarInventario()" class="form-group" style="margin: 0; max-width: 400px; width: 100%;">
                                </div>
                                <div class="admin-actions">
                                    <button class="btn-export" onclick="descargarPlantillaStock()">üì• Descargar Plantilla Stock</button>
                                    <button class="btn-import" onclick="document.getElementById('importStockFile').click()">üì§ Importar Stock</button>
                                    <input type="file" id="importStockFile" accept=".csv,.xls,.xlsx" style="display:none;" onchange="importarStock(event)">
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table class="admin-table">
                                    <thead>
                                        <tr>
                                            <th>Producto</th>
                                            <th>Stock Total</th>
                                            <th>Valor de Inventario (Costo)</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inventarioTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="movimientosView" style="display:none;">
                        <div class="admin-header">
                            <div>
                                <button class="btn-secondary" onclick="mostrarVistaAdmin('inventario')">‚Üê Volver al Inventario</button>
                                <h2 id="movimientosTitle" style="margin-top: 1rem;"></h2>
                            </div>
                        </div>
                        <div class="admin-section">
                            <div style="overflow-x: auto;">
                                <table class="admin-table">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Tipo</th>
                                            <th>Cantidad</th>
                                            <th>Stock Resultante</th>
                                            <th>Usuario</th>
                                            <th>Referencia (Pedido/Factura)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="movimientosTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="productosView" class="admin-view-content" style="display:none;">
                    <div class="admin-section">
                        <div class="admin-header">
                            <h2>Cat√°logo de Productos</h2>
                            <div class="admin-search-container">
                                <input type="text" id="productSearchInput" placeholder="Buscar por nombre o marca..." oninput="renderizarProductosAdmin()">
                                <button id="clearProductFilterBtn" class="btn-secondary" style="display: none;" onclick="limpiarFiltroProductos()">Limpiar</button>
                            </div>
                            <div class="admin-actions">
                                <button class="btn-export" onclick="descargarPlantilla()">üì• Descargar Plantilla XLS</button>
                                <button class="btn-import" onclick="document.getElementById('importFile').click()">üì§ Importar Archivo</button>
                                <input type="file" id="importFile" accept=".csv,.xls,.xlsx" style="display:none;" onchange="importarProductos(event)">
                                <button class="btn-secondary" onclick="abrirModalProducto()">+ Agregar Producto</button>
                            </div>
                        </div>
                        <h3 id="productFilterTitle" class="section-title" style="font-size: 1.2rem; text-align: left; margin-bottom: 1rem; display: none;"></h3>
                        <div style="overflow-x: auto;">
                            <table class="admin-table products-table">
                                <thead>
                                    <tr>
                                        <th>Imagen</th>
                                        <th>Nombre</th>
                                        <th>Categoria</th>
                                        <th>Precio Venta</th>
                                        <th>Variantes</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="adminProductsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="categoriasView" class="admin-view-content" style="display:none;">
                     <div class="admin-section">
                        <div class="admin-header">
                            <h2>Gesti√≥n de Categor√≠as</h2>
                            <button class="btn-secondary" onclick="abrirModalCategoria()">+ Agregar Categor√≠a</button>
                        </div>
                         <div style="overflow-x: auto;">
                            <table class="admin-table categories-table">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Slug</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="adminCategoriesTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="reportesView" class="admin-view-content" style="display:none;">
                    <div class="admin-nav" id="reportesNav" style="margin-bottom: 0; border-bottom: none;">
                        <button class="admin-nav-btn active" id="navBtnResumenVentas" onclick="mostrarSubVistaReporte('resumen')">Resumen de Ventas</button>
                        <button class="admin-nav-btn" id="navBtnVentasProducto" onclick="mostrarSubVistaReporte('porProducto')">Ventas por Producto</button>
                        <button class="admin-nav-btn" id="navBtnCompras" onclick="mostrarSubVistaReporte('compras')">Historial de Compras</button>
                    </div>

                    <!-- Reporte: Resumen de Ventas -->
                    <div id="reporteResumenView" class="reporte-subview">
                        <div class="admin-section">
                            <div class="admin-header" style="align-items: flex-end;">
                                <h2>Reporte de Ventas y Ganancias</h2>
                                <div class="admin-actions">
                                    <button class="btn-export" onclick="exportarReporteExcel()">üìä Exportar a Excel</button>
                                </div>
                            </div>
                            <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; align-items: flex-end;">
                                <div class="form-group" style="margin: 0;">
                                    <label>Desde</label>
                                    <input type="date" id="reporteFechaInicio">
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label>Hasta</label>
                                    <input type="date" id="reporteFechaFin">
                                </div>
                                <button class="btn-primary" style="width: auto; padding: 1rem 2rem;" onclick="generarReporteVentas()">Generar Reporte</button>
                            </div>
                        </div>
                        
                        <div class="kpi-container">
                            <div class="kpi-card">
                                <div class="kpi-card-title">Ingresos Totales (Venta)</div>
                                <div class="kpi-card-value" id="reporteKpiIngresos">S/ 0.00</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-card-title">Costo Total de Ventas</div>
                                <div class="kpi-card-value" id="reporteKpiCosto">S/ 0.00</div>
                            </div>
                            <div class="kpi-card" style="border-left: 4px solid var(--success);">
                                <div class="kpi-card-title">Ganancia Bruta</div>
                                <div class="kpi-card-value" id="reporteKpiGanancia">S/ 0.00</div>
                            </div>
                            <div class="kpi-card" style="border-left: 4px solid var(--info);">
                                <div class="kpi-card-title">Margen de Ganancia</div>
                                <div class="kpi-card-value" id="reporteKpiMargen">0.00 %</div>
                            </div>
                        </div>

                        <div class="admin-section">
                            <div style="overflow-x: auto;">
                                <table class="admin-table reportes-table">
                                    <thead>
                                        <tr>
                                            <th>N¬∞ Pedido</th>
                                            <th>Fecha</th>
                                            <th>Cliente</th>
                                            <th>Producto</th>
                                            <th>Cant.</th>
                                            <th>Total Venta</th>
                                            <th>Costo Total</th>
                                            <th>Ganancia</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reportesTableBody">
                                        <tr><td colspan="8" style="text-align: center; padding: 2rem;">Selecciona un rango de fechas y genera un reporte.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Reporte: Ventas por Producto -->
                    <div id="reportePorProductoView" class="reporte-subview" style="display:none;">
                        <div class="admin-section">
                            <div class="admin-header" style="align-items: flex-end;">
                                <h2>Reporte de Ventas por Producto</h2>
                            </div>
                            <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; align-items: flex-end;">
                                <div class="form-group" style="flex-grow: 1; min-width: 250px; margin:0;">
                                    <label>Producto</label>
                                    <select id="reporteProductoSelect"><option>Cargando productos...</option></select>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label>Desde</label>
                                    <input type="date" id="reporteProductoFechaInicio">
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label>Hasta</label>
                                    <input type="date" id="reporteProductoFechaFin">
                                </div>
                                <button class="btn-primary" style="width: auto; padding: 1rem 2rem;" onclick="generarReporteVentasPorProducto()">Generar Reporte</button>
                            </div>
                        </div>
                        <div class="admin-section">
                             <div style="overflow-x: auto;">
                                <table class="admin-table">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>N¬∞ Pedido</th>
                                            <th>Cliente</th>
                                            <th>Cantidad Vendida</th>
                                            <th>Total Venta</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reporteVentasPorProductoTableBody">
                                        <tr><td colspan="5" style="text-align: center; padding: 2rem;">Selecciona un producto y rango de fechas.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Reporte: Historial de Compras -->
                    <div id="reporteComprasView" class="reporte-subview" style="display:none;">
                        <div class="admin-section">
                            <div class="admin-header" style="align-items: flex-end;">
                                <h2>Historial de Compras (Ingresos de Stock)</h2>
                            </div>
                            <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; align-items: flex-end;">
                                <div class="form-group" style="margin: 0;">
                                    <label>Desde</label>
                                    <input type="date" id="reporteComprasFechaInicio">
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label>Hasta</label>
                                    <input type="date" id="reporteComprasFechaFin">
                                </div>
                                <button class="btn-primary" style="width: auto; padding: 1rem 2rem;" onclick="generarReporteCompras()">Generar Reporte</button>
                            </div>
                        </div>
                        <div class="admin-section">
                             <div style="overflow-x: auto;">
                                <table class="admin-table">
                                    <thead>
                                        <tr>
                                            <th>Fecha Ingreso</th>
                                            <th>Producto</th>
                                            <th>Cantidad</th>
                                            <th>N¬∞ Factura/Comprobante</th>
                                            <th>Proveedor</th>
                                            <th>Registrado por</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reporteComprasTableBody">
                                        <tr><td colspan="6" style="text-align: center; padding: 2rem;">Selecciona un rango de fechas para ver el historial de compras.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>


                <div id="configView" class="admin-view-content" style="display:none;">
                     <div class="admin-section">
                        <div class="admin-header">
                            <h2>Personalizaci√≥n de la Tienda</h2>
                        </div>
                        <form id="configForm" onsubmit="guardarConfiguracion(event)">
                            <div class="form-group">
                                <label for="heroImageUrl">URL de la Imagen Principal (Hero)</label>
                                <input type="url" id="heroImageUrl" placeholder="https://ejemplo.com/imagen.jpg">
                                <div class="form-hint">Pega la URL de una imagen de hamburguesas para la secci√≥n principal. Tama√±o recomendado: 1920x1080px.</div>
                            </div>
                            <button type="submit" class="btn-primary" id="btnGuardarConfig">Guardar Cambios</button>
                        </form>
                    </div>
                </div>

                <div id="ayudaView" class="admin-view-content" style="display:none;">
                    <div class="admin-header" style="margin-bottom: 0;">
                        <h2>Centro de Ayuda</h2>
                    </div>
                    <div class="help-card">
                        <h3>üöÄ Gu√≠a de Inicio R√°pido</h3>
                        <p>¬°Bienvenido al panel de control de tu hamburgueser√≠a! Sigue estos pasos para poner todo en marcha:</p>
                        <ol>
                            <li><strong>Crea tus Categor√≠as:</strong> Ve a la pesta√±a <strong>"Categor√≠as"</strong> y a√±ade las secciones para tu men√∫ (ej: Hamburguesas, Acompa√±amientos, Bebidas).</li>
                            <li><strong>A√±ade tus Productos:</strong> En la pesta√±a <strong>"Productos"</strong>, haz clic en "+ Agregar Producto". Aqu√≠ podr√°s definir si un producto requiere seguimiento por lotes con la nueva casilla <strong>"Gestionar por Lotes"</strong> (√∫til para carnes o insumos con vencimiento).</li>
                            <li><strong>Gestiona el Inventario:</strong> Ve al m√≥dulo de <strong>"Inventario"</strong>. Desde all√≠, puedes registrar nuevos ingresos de stock. Si un producto no es gestionado por lotes (ej: una gaseosa), el formulario ser√° m√°s simple y solo pedir√° la cantidad.</li>
                            <li><strong>Analiza tus Ventas:</strong> En la nueva pesta√±a <strong>"Reportes"</strong>, puedes explorar el resumen de ganancias, el historial de ventas por cada producto o el registro de todas tus compras de insumos.</li>
                            <li><strong>Gestiona tus Pedidos:</strong> Cuando recibas una venta, aparecer√° en la pesta√±a <strong>"Pedidos"</strong>. Al cambiar el estado a "Pago Confirmado" o "En Preparaci√≥n", el stock se descontar√° autom√°ticamente.</li>
                        </ol>
                    </div>
                    <div class="help-card">
                        <h3>ü§î Preguntas Frecuentes (FAQ)</h3>
                        <ul>
                            <li>
                                <strong>¬øPara qu√© sirve la opci√≥n "Gestionar por Lotes"?</strong>
                                <p>Esta opci√≥n te da flexibilidad. Para productos perecederos como la carne o panes artesanales, mantenla activada para una trazabilidad completa por fecha de vencimiento. Para productos como gaseosas o sachets de mayonesa, puedes desactivarla. Al hacerlo, el formulario para ingresar stock se simplificar√° y no te pedir√° un n√∫mero de lote, agilizando el proceso.</p>
                            </li>
                            <li>
                                <strong>¬øQu√© es el nuevo M√≥dulo de Reportes?</strong>
                                <p>Es un centro de an√°lisis que centraliza la informaci√≥n clave de tu negocio. Te permite ver no solo tus ganancias generales, sino tambi√©n desglosar las ventas por producto para ver cu√°les son tus hamburguesas estrella, y auditar todas tus compras para tener un control total de la trazabilidad de tu inventario.</p>
                            </li>
                             <li>
                                <strong>¬øC√≥mo a√±ado stock ahora?</strong>
                                <p>El proceso es el mismo: ve al m√≥dulo <strong>"Inventario"</strong>, busca el producto y haz clic en <strong>"Registrar Ingreso"</strong>. La √∫nica diferencia es que el formulario se adaptar√° autom√°ticamente dependiendo de si el producto gestiona lotes o no.</p>
                            </li>
                            <li>
                                <strong>¬øPara qu√© sirve el Historial de Movimientos?</strong>
                                <p>Es tu registro de auditor√≠a. Te permite responder preguntas como: "¬øQui√©n ingres√≥ este lote de carne?", "¬øCon qu√© factura se compr√≥?", "¬øEn qu√© pedido se vendi√≥ esta hamburguesa?". Esto te da un control total y visibilidad sobre tu inventario, ayud√°ndote a prevenir p√©rdidas y a gestionar tu negocio de forma m√°s profesional.</p>
                            </li>
                        </ul>
                    </div>
                    <div class="help-card">
                         <details>
                            <summary>üõ†Ô∏è Herramientas para Desarrolladores y Soluci√≥n de Problemas</summary>
                            <div style="padding-top: 1rem;">
                                <p>Esta secci√≥n contiene herramientas para la configuraci√≥n inicial o para solucionar problemas avanzados en la base de datos. <strong>No modifiques nada aqu√≠ a menos que sepas lo que est√°s haciendo.</strong></p>
                                <div class="auth-info" style="border-left-color: var(--primary); margin-top: 1rem;">
                                    <p><strong>Script de Sincronizaci√≥n de Base de Datos (Definitivo)</strong></p>
                                    <p class="form-hint" style="margin-top: 0.5rem;">
                                        Este script se usa una sola vez durante la instalaci√≥n para crear y configurar todas las tablas necesarias en tu base de datos de Supabase. Si tienes problemas como "columna no encontrada" o errores al guardar, ejecutar este script completo en el "SQL Editor" de Supabase suele solucionarlo.
                                    </p>
                                    <div class="sql-code" style="max-height: 400px; overflow-y: auto; margin-top: 1.5rem; text-align: left;">
<pre>
-- ========= SCRIPT DE CONFIGURACI√ìN Y SINCRONIZACI√ìN v12 (Gesti√≥n de Lotes Opcional) =========
CREATE TABLE IF NOT EXISTS public.categorias51 (id bigint PRIMARY KEY GENERATED ALWAYS AS IDENTITY, nombre text NOT NULL, slug text NOT NULL UNIQUE, created_at timestamptz DEFAULT now());
CREATE TABLE IF NOT EXISTS public.productos51 (id bigint PRIMARY KEY GENERATED ALWAYS AS IDENTITY, nombre text NOT NULL, precio numeric NOT NULL DEFAULT 0, created_at timestamptz DEFAULT now());
CREATE TABLE IF NOT EXISTS public.pedidos51 (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), numero_pedido serial NOT NULL, fecha_pedido timestamptz DEFAULT now(), nombre_cliente text, telefono_cliente text, email_cliente text, direccion text, productos jsonb, total numeric, cantidad_items integer, estado text, latitud double precision, longitud double precision);
CREATE TABLE IF NOT EXISTS public.configuracion51 (clave text PRIMARY KEY, valor text, updated_at timestamptz DEFAULT now());
CREATE TABLE IF NOT EXISTS public.lotes_inventario51 (id bigint PRIMARY KEY GENERATED ALWAYS AS IDENTITY, producto_id bigint NOT NULL, numero_lote text, fecha_vencimiento date, cantidad integer NOT NULL DEFAULT 0, created_at timestamptz DEFAULT now(), CONSTRAINT lotes_inventario_producto_id_fkey FOREIGN KEY (producto_id) REFERENCES public.productos51(id) ON DELETE CASCADE);
DO $$ BEGIN
    CREATE TYPE public.tipo_movimiento_enum AS ENUM ('INGRESO_COMPRA', 'SALIDA_VENTA', 'AJUSTE_MANUAL');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;
CREATE TABLE IF NOT EXISTS public.movimientos_inventario51 (id bigint PRIMARY KEY GENERATED ALWAYS AS IDENTITY, producto_id bigint NOT NULL, lote_id bigint, tipo_movimiento tipo_movimiento_enum NOT NULL, cantidad integer NOT NULL, stock_resultante integer NOT NULL, fecha_movimiento timestamptz DEFAULT now(), usuario_email text, referencia_id text, proveedor text, CONSTRAINT movimientos_inventario_producto_id_fkey FOREIGN KEY (producto_id) REFERENCES public.productos51(id) ON DELETE CASCADE, CONSTRAINT movimientos_inventario_lote_id_fkey FOREIGN KEY (lote_id) REFERENCES public.lotes_inventario51(id) ON DELETE SET NULL);

-- Sincronizaci√≥n de la tabla 'productos51'
ALTER TABLE public.productos51 DROP COLUMN IF EXISTS categoria;
ALTER TABLE public.productos51 ADD COLUMN IF NOT EXISTS marca text, ADD COLUMN IF NOT EXISTS descripcion text, ADD COLUMN IF NOT EXISTS imagen_url text, ADD COLUMN IF NOT EXISTS icon text, ADD COLUMN IF NOT EXISTS badge text, ADD COLUMN IF NOT EXISTS activo boolean DEFAULT true, ADD COLUMN IF NOT EXISTS variantes jsonb, ADD COLUMN IF NOT EXISTS categoria_id bigint, ADD COLUMN IF NOT EXISTS stock integer NOT NULL DEFAULT 0, ADD COLUMN IF NOT EXISTS precio_costo numeric NOT NULL DEFAULT 0, ADD COLUMN IF NOT EXISTS gestiona_lotes boolean DEFAULT true;
ALTER TABLE public.productos51 DROP CONSTRAINT IF EXISTS productos_categoria_id_fkey; 
ALTER TABLE public.productos51 ADD CONSTRAINT productos_categoria_id_fkey FOREIGN KEY (categoria_id) REFERENCES public.categorias51(id) ON DELETE SET NULL;

-- Sincronizaci√≥n de la tabla 'pedidos51'
ALTER TABLE public.pedidos51 ADD COLUMN IF NOT EXISTS stock_descontado boolean DEFAULT false NOT NULL;

-- Pol√≠ticas de Seguridad (RLS)
ALTER TABLE public.categorias51 ENABLE ROW LEVEL SECURITY; ALTER TABLE public.productos51 ENABLE ROW LEVEL SECURITY; ALTER TABLE public.pedidos51 ENABLE ROW LEVEL SECURITY; ALTER TABLE public.configuracion51 ENABLE ROW LEVEL SECURITY; ALTER TABLE public.lotes_inventario51 ENABLE ROW LEVEL SECURITY; ALTER TABLE public.movimientos_inventario51 ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public read access" ON public.categorias51; CREATE POLICY "Public read access" ON public.categorias51 FOR SELECT USING (true);
DROP POLICY IF EXISTS "Public read access" ON public.productos51; CREATE POLICY "Public read access" ON public.productos51 FOR SELECT USING (true);
DROP POLICY IF EXISTS "Public read access" ON public.configuracion51; CREATE POLICY "Public read access" ON public.configuracion51 FOR SELECT USING (true);
DROP POLICY IF EXISTS "Allow public insert" ON public.pedidos51; CREATE POLICY "Allow public insert" ON public.pedidos51 FOR INSERT WITH CHECK (true);
DROP POLICY IF EXISTS "Allow full access for authenticated users" ON public.categorias51; CREATE POLICY "Allow full access for authenticated users" ON public.categorias51 FOR ALL USING (auth.role() = 'authenticated') WITH CHECK (auth.role() = 'authenticated');
DROP POLICY IF EXISTS "Allow full access for authenticated users" ON public.productos51; CREATE POLICY "Allow full access for authenticated users" ON public.productos51 FOR ALL USING (auth.role() = 'authenticated') WITH CHECK (auth.role() = 'authenticated');
DROP POLICY IF EXISTS "Allow full access for authenticated users" ON public.pedidos51; CREATE POLICY "Allow full access for authenticated users" ON public.pedidos51 FOR ALL USING (auth.role() = 'authenticated') WITH CHECK (auth.role() = 'authenticated');
DROP POLICY IF EXISTS "Allow full access for authenticated users" ON public.configuracion51; CREATE POLICY "Allow full access for authenticated users" ON public.configuracion51 FOR ALL USING (auth.role() = 'authenticated') WITH CHECK (auth.role() = 'authenticated');
DROP POLICY IF EXISTS "Allow full access for authenticated users" ON public.lotes_inventario51; CREATE POLICY "Allow full access for authenticated users" ON public.lotes_inventario51 FOR ALL USING (auth.role() = 'authenticated') WITH CHECK (auth.role() = 'authenticated');
DROP POLICY IF EXISTS "Allow full access for authenticated users" ON public.movimientos_inventario51; CREATE POLICY "Allow full access for authenticated users" ON public.movimientos_inventario51 FOR ALL USING (auth.role() = 'authenticated') WITH CHECK (auth.role() = 'authenticated');

-- FUNCI√ìN PARA ACTUALIZAR EL STOCK TOTAL DE UN PRODUCTO
DROP FUNCTION IF EXISTS public.actualizar_stock_producto(bigint);
CREATE OR REPLACE FUNCTION public.actualizar_stock_producto(id_producto bigint) RETURNS integer LANGUAGE plpgsql SECURITY DEFINER AS $$
DECLARE stock_total integer;
BEGIN
    SELECT COALESCE(SUM(cantidad), 0) INTO stock_total FROM public.lotes_inventario51 WHERE producto_id = id_producto AND (fecha_vencimiento IS NULL OR fecha_vencimiento >= CURRENT_DATE);
    UPDATE public.productos51 SET stock = stock_total WHERE id = id_producto;
    RETURN stock_total;
END; $$;
GRANT EXECUTE ON FUNCTION public.actualizar_stock_producto(bigint) TO authenticated;

-- FUNCI√ìN PARA REGISTRAR INGRESO DE STOCK (con auditor√≠a)
CREATE OR REPLACE FUNCTION public.registrar_ingreso_stock(id_producto bigint, lotes jsonb, comprobante text, prov text) RETURNS void LANGUAGE plpgsql SECURITY DEFINER AS $$
DECLARE lote_data jsonb; nuevo_lote_id bigint; stock_actualizado integer;
BEGIN
    FOR lote_data IN SELECT * FROM jsonb_array_elements(lotes) LOOP
        INSERT INTO public.lotes_inventario51 (producto_id, numero_lote, fecha_vencimiento, cantidad)
        VALUES (id_producto, lote_data->>'numero_lote', (lote_data->>'fecha_vencimiento')::date, (lote_data->>'cantidad')::integer)
        RETURNING id INTO nuevo_lote_id;

        SELECT public.actualizar_stock_producto(id_producto) INTO stock_actualizado;

        INSERT INTO public.movimientos_inventario51 (producto_id, lote_id, tipo_movimiento, cantidad, stock_resultante, usuario_email, referencia_id, proveedor)
        VALUES (id_producto, nuevo_lote_id, 'INGRESO_COMPRA', (lote_data->>'cantidad')::integer, stock_actualizado, auth.email(), comprobante, prov);
    END LOOP;
END; $$;
GRANT EXECUTE ON FUNCTION public.registrar_ingreso_stock(bigint, jsonb, text, text) TO authenticated;

-- FUNCI√ìN PARA DESCONTAR STOCK (Transaccional, FEFO y con auditor√≠a)
CREATE OR REPLACE FUNCTION public.descontar_stock_pedido(id_pedido uuid) RETURNS text LANGUAGE plpgsql SECURITY DEFINER AS $$
DECLARE producto_rec record; lote_rec record; cantidad_a_descontar integer; stock_total_producto integer; stock_actualizado integer; pedido_numero integer;
BEGIN
    IF (SELECT stock_descontado FROM public.pedidos51 WHERE id = id_pedido) THEN RETURN 'El stock para este pedido ya fue descontado previamente.'; END IF;
    SELECT numero_pedido INTO pedido_numero FROM public.pedidos51 WHERE id = id_pedido;
    FOR producto_rec IN SELECT (p->>'id')::bigint AS producto_id, (p->>'cantidad')::integer AS cantidad, (p->>'producto')::text AS nombre_producto FROM public.pedidos51, jsonb_array_elements(productos) AS p WHERE id = id_pedido LOOP
        SELECT stock INTO stock_total_producto FROM public.productos51 WHERE id = producto_rec.producto_id;
        IF stock_total_producto &lt; producto_rec.cantidad THEN RAISE EXCEPTION 'Stock insuficiente para el producto: "%". Stock total actual: %, Requerido: %', producto_rec.nombre_producto, stock_total_producto, producto_rec.cantidad; END IF;
    END LOOP;
    FOR producto_rec IN SELECT (p->>'id')::bigint AS producto_id, (p->>'cantidad')::integer AS cantidad FROM public.pedidos51, jsonb_array_elements(productos) AS p WHERE id = id_pedido LOOP
        cantidad_a_descontar := producto_rec.cantidad;
        FOR lote_rec IN SELECT * FROM public.lotes_inventario51 WHERE producto_id = producto_rec.producto_id AND cantidad > 0 AND (fecha_vencimiento IS NULL OR fecha_vencimiento >= CURRENT_DATE) ORDER BY fecha_vencimiento ASC NULLS LAST LOOP
            IF cantidad_a_descontar = 0 THEN EXIT; END IF;
            IF lote_rec.cantidad >= cantidad_a_descontar THEN
                UPDATE public.lotes_inventario51 SET cantidad = cantidad - cantidad_a_descontar WHERE id = lote_rec.id;
                SELECT public.actualizar_stock_producto(producto_rec.producto_id) INTO stock_actualizado;
                INSERT INTO public.movimientos_inventario51 (producto_id, lote_id, tipo_movimiento, cantidad, stock_resultante, usuario_email, referencia_id) VALUES (producto_rec.producto_id, lote_rec.id, 'SALIDA_VENTA', cantidad_a_descontar * -1, stock_actualizado, auth.email(), 'Pedido #' || pedido_numero);
                cantidad_a_descontar := 0;
            ELSE
                INSERT INTO public.movimientos_inventario51 (producto_id, lote_id, tipo_movimiento, cantidad, stock_resultante, usuario_email, referencia_id) VALUES (producto_rec.producto_id, lote_rec.id, 'SALIDA_VENTA', lote_rec.cantidad * -1, (SELECT stock FROM public.productos51 WHERE id = producto_rec.producto_id) - lote_rec.cantidad, auth.email(), 'Pedido #' || pedido_numero);
                cantidad_a_descontar := cantidad_a_descontar - lote_rec.cantidad;
                UPDATE public.lotes_inventario51 SET cantidad = 0 WHERE id = lote_rec.id;
            END IF;
        END LOOP;
        IF cantidad_a_descontar > 0 THEN RAISE EXCEPTION 'Error de concurrencia o stock inconsistente al procesar el producto ID %.', producto_rec.producto_id; END IF;
        PERFORM public.actualizar_stock_producto(producto_rec.producto_id);
    END LOOP;
    UPDATE public.pedidos51 SET stock_descontado = true WHERE id = id_pedido;
    RETURN 'Stock descontado exitosamente con estrategia FEFO y auditor√≠a registrada.';
END; $$;
GRANT EXECUTE ON FUNCTION public.descontar_stock_pedido(uuid) TO authenticated;

NOTIFY pgrst_reload_schema;
</pre>
                                    </div>
                                </div>
                            </div>
                         </details>
                    </div>
                </div>
                
                <div id="loadingAdmin" class="loading" style="display:none;">Cargando...</div>
            </div>
        </main>
    </div>

    <div id="cartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Tu Carrito</h2>
                <button class="close-btn" onclick="cerrarCarrito()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="cartContent"></div>
                <div id="successMessage" class="success-message">
                    <div class="success-icon">‚úì</div>
                    <h3>Pedido Realizado con Exito</h3>
                    <p>Hemos recibido tu pedido. Revisa el estado en tu cuenta o contactanos para coordinar la entrega.</p>
                    <button class="btn-primary" onclick="cerrarYLimpiar()">Continuar Comprando</button>
                </div>
            </div>
        </div>
    </div>

    <div id="productoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="productoModalTitle">Agregar Producto</h2>
                <button class="close-btn" onclick="cerrarModalProducto()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="productoForm" onsubmit="guardarProducto(event)">
                    <input type="hidden" id="productoId">
                    <input type="file" id="variantImageFile" accept="image/*" style="display:none;" onchange="subirImagenVariante(event)">
                    <div class="form-group">
                        <label>Nombre del Producto</label>
                        <input type="text" id="productoNombre" required>
                    </div>
                    <div class="form-group">
                        <label>Marca/Tipo</label>
                        <input type="text" id="productoMarca" required placeholder="Ej: Cl√°sica, Angus, Artesanal">
                    </div>
                    <div class="form-group">
                        <label>Categoria</label>
                        <select id="productoCategoria" required>
                           <option value="">Cargando categor√≠as...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Descripcion</label>
                        <textarea id="productoDescripcion" required></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Precio de Costo (S/)</label>
                            <input type="number" id="productoCosto" step="0.01" min="0" required value="0">
                            <div class="form-hint">No es visible para el cliente. Usado para calcular ganancias y valor de inventario.</div>
                        </div>
                        <div class="form-group">
                            <label>Precio de Venta (S/)</label>
                            <input type="number" id="productoPrecio" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Imagen Principal (URL) - Usada si no hay im√°genes en variantes</label>
                        <input type="url" id="productoImagen" placeholder="https://ejemplo.com/hamburguesa.jpg">
                    </div>
                    <div class="form-group">
                        <label>Icono (Emoji) - Se usa si no hay imagen</label>
                        <input type="text" id="productoIcon" maxlength="2" placeholder="üçî">
                    </div>
                    <div class="form-group">
                        <label>Etiqueta (Opcional)</label>
                        <input type="text" id="productoBadge" placeholder="Nuevo, Popular, Picante...">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="productoActivo" checked> Producto activo
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="productoGestionLote" checked> Gestionar por Lotes y Vencimiento
                        </label>
                        <div class="form-hint">Si se desmarca, no se pedir√° lote ni vencimiento al ingresar stock. Ideal para productos sin trazabilidad espec√≠fica como gaseosas.</div>
                    </div>
                    <div class="variantes-container">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label style="margin: 0;">Variantes (ej: Termino, Extras)</label>
                            <button type="button" class="btn-secondary" style="padding: 0.5rem 1rem;" onclick="agregarTipoVariante()">+ Agregar tipo</button>
                        </div>
                         <div class="form-hint">A√±ade opciones para tu producto. Los clientes deber√°n elegir una de cada tipo. Haz clic en üñºÔ∏è para asignar una imagen. El stock se gestiona desde el M√≥dulo de Inventario.</div>
                        <div id="variantesContainer"></div>
                    </div>
                    <button type="submit" class="btn-primary" id="btnGuardarProducto" style="margin-top: 1.5rem;">Guardar Producto</button>
                </form>
            </div>
        </div>
    </div>
    
    <div id="categoriaModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="categoriaModalTitle">Agregar Categor√≠a</h2>
                <button class="close-btn" onclick="cerrarModalCategoria()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="categoriaForm" onsubmit="guardarCategoria(event)">
                    <input type="hidden" id="categoriaId">
                    <div class="form-group">
                        <label for="categoriaNombre">Nombre de la Categor√≠a</label>
                        <input type="text" id="categoriaNombre" oninput="generarSlug(this.value)" required>
                        <div class="form-hint">Ej: Hamburguesas Cl√°sicas</div>
                    </div>
                    <div class="form-group">
                        <label for="categoriaSlug">Slug (URL)</label>
                        <input type="text" id="categoriaSlug" required>
                        <div class="form-hint">Identificador √∫nico en min√∫sculas y sin espacios. Ej: hamburguesas-clasicas</div>
                    </div>
                    <button type="submit" class="btn-primary" id="btnGuardarCategoria">Guardar Categor√≠a</button>
                </form>
            </div>
        </div>
    </div>

    <div id="pedidoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="pedidoModalTitle">Detalles del Pedido</h2>
                <button class="close-btn" onclick="cerrarModalPedido()">&times;</button>
            </div>
            <div class="modal-body" id="pedidoModalBody">
                <!-- Content will be injected by JavaScript -->
            </div>
        </div>
    </div>
    
    <div id="detalleProductoModal" class="modal">
        <div class="modal-content">
            <div class="product-image-modal" id="detalleProductoImagen"></div>
            <div class="modal-body">
                 <button class="close-btn" style="position: absolute; top: 1rem; right: 1rem;" onclick="cerrarModalDetalleProducto()">&times;</button>
                <h2 id="detalleProductoNombre" style="color: var(--primary); font-size: 2rem; margin-bottom: 0.5rem;"></h2>
                <div id="detalleProductoMarca" style="color: var(--text-light); margin-bottom: 0.5rem;"></div>
                <p id="detalleProductoDescripcion" style="margin-bottom: 1.5rem;"></p>
                <div id="detalleProductoVariantes"></div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem;">
                    <span id="detalleProductoPrecio" class="product-price" style="margin: 0; padding: 0;"></span>
                    <button id="btnAgregarDesdeModal" class="add-to-cart-btn" style="width: auto; padding: 1rem 2rem;" onclick="agregarAlCarritoDesdeModal()">Agregar al Carrito</button>
                </div>
            </div>
        </div>
    </div>

    <div id="mapModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="mapModalTitle">Ubicaci√≥n de Entrega</h2>
                <button class="close-btn" onclick="cerrarModalMapa()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="mapa"></div>
                <div id="mapaActions" style="text-align: right; margin-top: 1rem; display: none;">
                    <button class="btn-primary" onclick="confirmarUbicacionDesdeMapa()">Confirmar Ubicaci√≥n</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="ingresoStockModal" class="modal">
        <div class="modal-content ingreso-stock-modal-content">
            <div class="modal-header">
                <h2 id="ingresoStockModalTitle">Registrar Ingreso de Stock</h2>
                <button class="close-btn" onclick="cerrarModalIngresoStock()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="ingresoStockForm" onsubmit="registrarIngresoStock(event)">
                    <input type="hidden" id="ingresoProductoId">
                    <div class="admin-section" style="padding: 1rem; margin: 0; margin-bottom: 2rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group" style="margin: 0;">
                                <label>N¬∞ de Factura/Comprobante</label>
                                <input type="text" id="ingresoComprobante" required>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label>Proveedor (Opcional)</label>
                                <input type="text" id="ingresoProveedor">
                            </div>
                        </div>
                    </div>

                    <h4 id="lotesContainerTitle">Lotes a Ingresar</h4>
                    <div id="lotesParaIngresarContainer">
                        <!-- Lotes se a√±aden aqu√≠ din√°micamente -->
                    </div>
                    <button type="button" class="btn-secondary" id="btnAddLote" onclick="agregarLoteParaIngresoDesdeBoton()" style="margin-top: 1rem;">+ A√±adir otro lote</button>
                    
                    <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border-color);">

                    <button type="submit" class="btn-primary" style="width: 100%;">Confirmar Ingreso de Stock</button>
                </form>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-logo">Pedidos51</div>
        <p>2025 Pedidos51. Todos los derechos reservados.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        const SUPABASE_URL = 'https://zejzrujrspeoszpfbjce.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InplanpydWpyc3Blb3N6cGZiamNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2MDMyNDMsImV4cCI6MjA3NTE3OTI0M30.UAi4jQ0BH1hphW7OEh4JWP4hdVJ4CmvX6x4CyP2ak-U';
        const CLOUDINARY_CLOUD_NAME = 'dvj68er8s';
        const CLOUDINARY_UPLOAD_PRESET = 'red51_productos';
        
        let carrito = [];
        let supabaseClient = null;
        let categoriaActual = 'todos';
        let productos = [];
        let productosAdmin = [];
        let categorias = [];
        let pedidos = [];
        let inventario = [];
        let movimientos = [];
        let datosReporteActual = [];
        let usuarioActual = null;
        let configuracion = {};
        let mapa;
        let mapaMarker;
        let onMapaConfirmCallback = null;
        let estadoPedidoActual = 'todos';
        let pedidosChannel = null;
        let productoSeleccionado = null;
        const estadosPosibles = ['pendiente_pago', 'pago_confirmado', 'en_preparacion', 'enviado', 'entregado', 'cancelado'];
        let currentVariantPreviewElement = null;
        let isLowStockFilterActive = false;
        const colorMap = {
            'rojo': '#ef4444', 'azul': '#3b82f6', 'verde': '#22c55e', 'negro': '#1f2937',
            'blanco': '#ffffff', 'amarillo': '#f59e0b', 'naranja': '#f97316', 'morado': '#8b5cf6',
            'rosa': '#ec4899', 'gris': '#6b7280', 'plata': '#d1d5db', 'dorado': '#ca8a04',
            'marr√≥n': '#78350f', 'cafe': '#78350f'
        };


        async function inicializarSupabase() {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            await cargarConfiguracion();
            await cargarCategorias();
            await cargarProductos();
            await verificarSesion();
        }

        async function cargarConfiguracion() {
            if (!supabaseClient) return;
            try {
                const { data, error } = await supabaseClient
                    .from('configuracion51')
                    .select('clave, valor');
                
                if (error) {
                    console.warn('No se pudo cargar la configuraci√≥n de la tienda:', error.message);
                }

                if (data) {
                    configuracion = data.reduce((acc, curr) => {
                        acc[curr.clave] = curr.valor;
                        return acc;
                    }, {});
                }

                const heroSection = document.getElementById('heroSection');
                if (configuracion.hero_image_url) {
                    heroSection.style.backgroundImage = `url('${configuracion.hero_image_url}')`;
                } else {
                    heroSection.style.background = 'linear-gradient(135deg, #F9D423 0%, #FF4E50 100%)';
                }
            } catch (error) {
                console.error('Ocurri√≥ un error inesperado al procesar la configuraci√≥n de la tienda:', error.message || error);
            }
        }

        async function cargarCategorias() {
            if (!supabaseClient) return;
            try {
                const { data, error } = await supabaseClient.from('categorias51').select('*').order('nombre');
                if (error) {
                    console.warn("Advertencia al cargar categor√≠as:", error.message);
                    categorias = [];
                } else {
                    categorias = data || [];
                }
            } catch (error) {
                console.error("Error inesperado al cargar categor√≠as:", error.message);
                categorias = [];
            } finally {
                renderizarFiltrosCategorias();
                llenarSelectorCategoriasProducto();
            }
        }

        async function verificarSesion() {
            if (!supabaseClient) return;
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                usuarioActual = session.user;
                mostrarPanelAdmin();
            }
        }

        async function iniciarSesion(event) {
            event.preventDefault();
            const email = document.getElementById('emailLogin').value;
            const password = document.getElementById('passwordLogin').value;
            const errorDiv = document.getElementById('loginError');
            errorDiv.style.display = 'none';
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                usuarioActual = data.user;
                mostrarPanelAdmin();
            } catch (error) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Error al iniciar sesion: ' + error.message;
            }
        }

        function mostrarPanelAdmin() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('adminEmail').textContent = usuarioActual.email;
            
            cargarPedidos();
            cargarProductosAdmin();
            cargarCategoriasAdmin();
            cargarConfiguracionAdmin();
            cargarInventario();
            inicializarReportes();

            mostrarVistaAdmin('pedidos');
            suscribirACambiosPedidos();
        }

        function mostrarVistaAdmin(vista, subVista = null) {
            document.querySelectorAll('.admin-view-content').forEach(v => v.style.display = 'none');
            document.querySelectorAll('.admin-nav-btn').forEach(b => b.classList.remove('active'));

            const vistaPrincipal = vista.startsWith('movimientos') ? 'inventario' : vista;
            
            document.getElementById(`${vistaPrincipal}View`).style.display = 'block';
            document.getElementById(`navBtn${vistaPrincipal.charAt(0).toUpperCase() + vistaPrincipal.slice(1)}`).classList.add('active');

            if (vista === 'inventario') {
                document.getElementById('inventarioDashboard').style.display = 'block';
                document.getElementById('movimientosView').style.display = 'none';
            } else if (vista === 'movimientos') {
                document.getElementById('inventarioDashboard').style.display = 'none';
                document.getElementById('movimientosView').style.display = 'block';
            }
        }
        
        function navegarAProductos() {
            limpiarFiltroProductos();
            mostrarVistaAdmin('productos');
        }

        function cargarConfiguracionAdmin() {
            const heroInput = document.getElementById('heroImageUrl');
            if (heroInput) heroInput.value = configuracion.hero_image_url || '';

            const form = document.getElementById('configForm');
            const saveBtn = document.getElementById('btnGuardarConfig');
            saveBtn.disabled = true;
            saveBtn.title = 'No hay cambios para guardar';
            form.oninput = () => {
                saveBtn.disabled = false;
                saveBtn.title = 'Guardar Cambios';
            };
        }

        async function guardarConfiguracion(event) {
            event.preventDefault();
            const btn = document.getElementById('btnGuardarConfig');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Guardando...';

            const heroImageUrl = document.getElementById('heroImageUrl').value;

            try {
                const { error } = await supabaseClient
                    .from('configuracion51')
                    .upsert({ clave: 'hero_image_url', valor: heroImageUrl }, { onConflict: 'clave' });
                if (error) throw error;
                
                mostrarNotificacion('Configuraci√≥n guardada exitosamente.');
                await cargarConfiguracion();
                btn.title = 'No hay cambios para guardar';
            } catch (error) {
                alert('Error al guardar: ' + error.message);
                btn.disabled = false;
            } finally {
                btn.textContent = originalText;
            }
        }

        async function cerrarSesion() {
            if (pedidosChannel) {
                supabaseClient.removeChannel(pedidosChannel);
                pedidosChannel = null;
            }
            await supabaseClient.auth.signOut();
            usuarioActual = null;
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            mostrarTienda();
        }

        function mostrarTienda() {
            document.getElementById('tiendaView').style.display = 'block';
            document.getElementById('adminView').style.display = 'none';
        }

        function mostrarAdmin() {
            document.getElementById('tiendaView').style.display = 'none';
            document.getElementById('adminView').style.display = 'block';
            if (usuarioActual) mostrarPanelAdmin();
            else {
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'none';
            }
        }

        async function cargarProductos() {
            if (!supabaseClient) return;
            document.getElementById('loadingProducts').style.display = 'block';
            document.getElementById('productsGrid').innerHTML = '';
            try {
                const { data, error } = await supabaseClient
                    .from('productos51')
                    .select('*, categorias51(nombre, slug)')
                    .eq('activo', true)
                    .order('nombre');

                if (error) throw error;
                
                productos = data || [];
                
                if (productos.length === 0) {
                    document.getElementById('productsGrid').innerHTML = 
                        '<div class="empty-cart"><p>No hay productos disponibles. Ve al panel Admin para agregar productos.</p></div>';
                    return;
                }
                
                renderizarProductos();

            } catch (error) {
                document.getElementById('productsGrid').innerHTML = 
                    `<div class="empty-cart"><p>Error al cargar productos: ${error.message}</p><p style="font-size: 0.8rem; color: #999;">Aseg√∫rate de haber ejecutado el script de configuraci√≥n desde la pesta√±a de Ayuda en el panel Admin.</p></div>`;
                productos = [];
            } finally {
                document.getElementById('loadingProducts').style.display = 'none';
            }
        }

        function renderizarFiltrosCategorias() {
            const filterContainer = document.getElementById('categoryFilter');
            filterContainer.innerHTML = `
                <button class="filter-btn ${'todos' === categoriaActual ? 'active' : ''}" onclick="filtrarCategoria('todos')">
                    Todos
                </button>
                ${categorias.map(cat => `
                    <button class="filter-btn ${cat.slug === categoriaActual ? 'active' : ''}" 
                            onclick="filtrarCategoria('${cat.slug}')">
                        ${cat.nombre}
                    </button>
                `).join('')}`;
        }

        function filtrarCategoria(slug) {
            categoriaActual = slug;
            renderizarFiltrosCategorias();
            renderizarProductos();
        }

        function renderizarProductos() {
            const grid = document.getElementById('productsGrid');
            const productosFiltrados = categoriaActual === 'todos' 
                ? productos 
                : productos.filter(p => p.categorias51 && p.categorias51.slug === categoriaActual);
            
            if (productosFiltrados.length === 0) {
                grid.innerHTML = '<div class="empty-cart"><p>No hay productos en esta categoria.</p></div>';
                return;
            }

            grid.innerHTML = productosFiltrados.map(producto => {
                const hasVariants = producto.variantes && Array.isArray(producto.variantes) && producto.variantes.length > 0;
                
                let imagenPrincipal = producto.imagen_url;
                if (hasVariants) {
                    const primeraOpcionConImagen = producto.variantes
                        .flatMap(v => v.opciones || [])
                        .find(o => o.imagen_url);
                    if (primeraOpcionConImagen) {
                        imagenPrincipal = primeraOpcionConImagen.imagen_url;
                    }
                }
                
                let variantesHTML = '';
                if (hasVariants) {
                    const colorVariant = producto.variantes.find(v => v.nombre.toLowerCase() === 'color');
                    if (colorVariant && colorVariant.opciones) {
                        variantesHTML = `<div class="variant-swatches">
                            ${colorVariant.opciones.map(opcion => {
                                const colorValue = opcion.valor.toLowerCase();
                                const cssColor = colorMap[colorValue] || '#e5e7eb'; // Default color
                                return `<div class="color-swatch" style="background-color: ${cssColor};" title="${opcion.valor}"></div>`;
                            }).join('')}
                        </div>`;
                    }
                }


                return `
                <div class="product-card">
                    <div class="product-image">
                        ${imagenPrincipal 
                            ? `<img src="${optimizarImagenUrl(imagenPrincipal)}" alt="${producto.nombre}" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                               <span style="display:none">${producto.icon || 'üçî'}</span>`
                            : `<span>${producto.icon || 'üçî'}</span>`
                        }
                        ${producto.badge ? `<span class="product-badge">${producto.badge}</span>` : ''}
                        ${producto.stock <= 0 ? `<span class="product-badge" style="background: var(--text-dark); left: 15px; right: auto;">Agotado</span>` : ''}
                    </div>
                    <div class="product-info">
                        <div class="product-category">${producto.categorias51 ? producto.categorias51.nombre : 'Sin Categor√≠a'}</div>
                        <h3 class="product-name">${producto.nombre}</h3>
                        <div class="product-brand">${producto.marca}</div>
                        <p class="product-description">${producto.descripcion}</p>
                        <div style="margin-top: auto; padding-top: 1rem;">
                            ${variantesHTML}
                            ${producto.stock > 0 && producto.stock <= 10 ? `<div class="product-stock">¬°Solo quedan ${producto.stock} en stock!</div>` : ''}
                            <div class="product-price">S/ ${parseFloat(producto.precio).toFixed(2)}</div>
                        </div>
                        ${producto.stock > 0 ?
                            (hasVariants 
                                ? `<button class="add-to-cart-btn" onclick="abrirModalDetalleProducto(${producto.id})">Ver Opciones</button>`
                                : `<button class="add-to-cart-btn" onclick="agregarAlCarrito(${producto.id})">Agregar al Carrito</button>`
                            )
                            : `<button class="add-to-cart-btn" disabled style="background: var(--text-light); cursor: not-allowed;">Agotado</button>`
                        }
                    </div>
                </div>
            `}).join('');
        }
        
        // --- Product Detail Modal ---
        function abrirModalDetalleProducto(id) {
            productoSeleccionado = productos.find(p => p.id === id);
            if (!productoSeleccionado) return;

            let imagenInicial = productoSeleccionado.imagen_url;
            if (productoSeleccionado.variantes && productoSeleccionado.variantes.length > 0) {
                const primeraOpcionConImagen = productoSeleccionado.variantes
                    .flatMap(v => v.opciones || [])
                    .find(o => o.imagen_url);
                if (primeraOpcionConImagen) {
                    imagenInicial = primeraOpcionConImagen.imagen_url;
                }
            }

            document.getElementById('detalleProductoImagen').innerHTML = imagenInicial
                ? `<img src="${optimizarImagenUrl(imagenInicial, 800)}" alt="${productoSeleccionado.nombre}">`
                : `<span style="font-size: 8rem;">${productoSeleccionado.icon || 'üçî'}</span>`;

            document.getElementById('detalleProductoNombre').textContent = productoSeleccionado.nombre;
            document.getElementById('detalleProductoMarca').textContent = productoSeleccionado.marca;
            document.getElementById('detalleProductoDescripcion').textContent = productoSeleccionado.descripcion;
            document.getElementById('detalleProductoPrecio').textContent = `S/ ${parseFloat(productoSeleccionado.precio).toFixed(2)}`;

            const variantesContainer = document.getElementById('detalleProductoVariantes');
            variantesContainer.innerHTML = (productoSeleccionado.variantes || []).map(variante => `
                <div class="form-group">
                    <label>${variante.nombre}</label>
                    <select class="variante-select" data-variante-nombre="${variante.nombre}">
                        <option value="">Seleccionar ${variante.nombre}</option>
                        ${(variante.opciones || []).map(opcion => `<option value="${opcion.valor}">${opcion.valor}</option>`).join('')}
                    </select>
                </div>
            `).join('');
            
             document.querySelectorAll('#detalleProductoVariantes .variante-select').forEach(select => {
                select.addEventListener('change', () => {
                    const varianteNombre = select.dataset.varianteNombre;
                    const opcionValor = select.value;

                    const variante = productoSeleccionado.variantes.find(v => v.nombre === varianteNombre);
                    if (variante) {
                        const opcion = (variante.opciones || []).find(o => o.valor === opcionValor);
                        if (opcion && opcion.imagen_url) {
                            const imgContainer = document.getElementById('detalleProductoImagen');
                            imgContainer.innerHTML = `<img src="${optimizarImagenUrl(opcion.imagen_url, 800)}" alt="${productoSeleccionado.nombre}">`;
                        }
                    }
                });
            });

            document.getElementById('detalleProductoModal').classList.add('show');
        }

        function cerrarModalDetalleProducto() {
            document.getElementById('detalleProductoModal').classList.remove('show');
            productoSeleccionado = null;
        }

        function agregarAlCarritoDesdeModal() {
            const variantesSeleccionadas = {};
            const selects = document.querySelectorAll('#detalleProductoVariantes .variante-select');
            let allSelected = true;

            selects.forEach(select => {
                const label = select.previousElementSibling.textContent;
                if (select.value) {
                    variantesSeleccionadas[label] = select.value;
                } else {
                    allSelected = false;
                }
            });

            if (!allSelected) {
                mostrarNotificacion('‚ö†Ô∏è Por favor, selecciona una opci√≥n para cada variante.');
                return;
            }

            agregarAlCarrito(productoSeleccionado.id, variantesSeleccionadas);
            cerrarModalDetalleProducto();
        }


        // --- Cart Logic ---
        function generarCartId(productoId, variantes) {
            if (!variantes) return productoId.toString();
            const variantString = Object.entries(variantes)
                .sort(([keyA], [keyB]) => keyA.localeCompare(keyB))
                .map(([key, value]) => `${key}:${value}`)
                .join('|');
            return `${productoId}-${variantString}`;
        }

        function agregarAlCarrito(productoId, variantesSeleccionadas = null) {
            const producto = productos.find(p => p.id === productoId);
            if (!producto) return;

            const cartId = generarCartId(productoId, variantesSeleccionadas);
            const itemExistente = carrito.find(item => item.cartId === cartId);
            const cantidadEnCarrito = itemExistente ? itemExistente.cantidad : 0;

            if (cantidadEnCarrito + 1 > producto.stock) {
                mostrarNotificacion(`‚ö†Ô∏è Stock insuficiente. Solo quedan ${producto.stock} unidades.`);
                return;
            }

            if (itemExistente) {
                itemExistente.cantidad++;
            } else {
                carrito.push({
                    ...producto,
                    cantidad: 1,
                    variantes_seleccionadas: variantesSeleccionadas,
                    cartId: cartId
                });
            }
            actualizarContadorCarrito();
            mostrarNotificacion('‚úÖ Producto agregado al carrito');
        }

        function actualizarContadorCarrito() {
            document.getElementById('cartCount').textContent = carrito.reduce((sum, item) => sum + item.cantidad, 0);
        }

        function abrirCarrito() {
            document.getElementById('cartModal').classList.add('show');
            renderizarCarrito();
        }

        function cerrarCarrito() {
            document.getElementById('cartModal').classList.remove('show');
        }

        function renderizarCarrito() {
            const content = document.getElementById('cartContent');
            document.getElementById('successMessage').style.display = 'none';
            if (carrito.length === 0) {
                content.innerHTML = `<div class="empty-cart"><div class="empty-cart-icon">üõí</div><p>Tu carrito esta vacio</p></div>`;
                return;
            }
            const total = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
            content.innerHTML = `
                ${carrito.map(item => `
                    <div class="cart-item">
                        <div class="cart-item-icon">${item.icon || 'üçî'}</div>
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.nombre}</div>
                             ${item.variantes_seleccionadas ? `<div class="cart-item-variants">${Object.entries(item.variantes_seleccionadas).map(([k, v]) => `${k}: ${v}`).join(', ')}</div>` : ''}
                            <div class="cart-item-brand">${item.marca}</div>
                            <div class="cart-item-price">S/ ${parseFloat(item.precio).toFixed(2)} c/u</div>
                            <div class="cart-item-controls">
                                <button class="qty-btn" onclick="cambiarCantidad('${item.cartId}', -1)">-</button>
                                <span class="qty-display">${item.cantidad}</span>
                                <button class="qty-btn" onclick="cambiarCantidad('${item.cartId}', 1)">+</button>
                                <button class="remove-btn" onclick="eliminarItem('${item.cartId}')">Eliminar</button>
                            </div>
                        </div>
                        <div style="font-weight: 700; font-size: 1.2rem; color: var(--primary);">
                            S/ ${(item.precio * item.cantidad).toFixed(2)}
                        </div>
                    </div>
                `).join('')}
                <div class="cart-total">
                    <span class="cart-total-label">Total:</span>
                    <span class="cart-total-amount">S/ ${total.toFixed(2)}</span>
                </div>
                <form class="checkout-form" onsubmit="realizarPedido(event)">
                    <div class="form-group"><label>Nombre Completo</label><input type="text" id="nombreCliente" required></div>
                    <div class="form-group"><label>Telefono (sin prefijo +51)</label><input type="tel" id="telefonoCliente" required placeholder="905820448"></div>
                    <div class="form-group"><label>Email (Opcional)</label><input type="email" id="emailCliente" placeholder="cliente@ejemplo.com"></div>
                    <div class="form-group">
                        <label>Direccion de Entrega</label>
                        <textarea id="direccionCliente" required></textarea>
                         <input type="hidden" id="latitudCliente"><input type="hidden" id="longitudCliente">
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <button type="button" class="btn-secondary" style="font-size: 0.9rem;" onclick="usarUbicacionActual()">üìç Usar mi ubicaci√≥n actual</button>
                            <button type="button" class="btn-secondary" style="font-size: 0.9rem;" onclick="seleccionarUbicacionEnMapa()">üó∫Ô∏è Seleccionar en el mapa</button>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" id="btnRealizarPedido">Realizar Pedido</button>
                </form>`;
        }

        function cambiarCantidad(cartId, cambio) {
            const itemIndex = carrito.findIndex(item => item.cartId === cartId);
            if (itemIndex === -1) return;

            const item = carrito[itemIndex];
            const producto = productos.find(p => p.id === item.id);

            if (cambio > 0 && producto && (item.cantidad + cambio > producto.stock)) {
                mostrarNotificacion(`‚ö†Ô∏è Stock insuficiente. Solo quedan ${producto.stock} unidades.`);
                return;
            }

            item.cantidad += cambio;
            if (item.cantidad <= 0) {
                carrito.splice(itemIndex, 1);
            }
            
            actualizarContadorCarrito();
            renderizarCarrito();
        }

        function eliminarItem(cartId) {
            carrito = carrito.filter(item => item.cartId !== cartId);
            actualizarContadorCarrito();
            renderizarCarrito();
        }
        
        async function geocodeDireccion(direccion) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion)}`);
                if (!response.ok) throw new Error('Servicio de geocodificaci√≥n no disponible');
                const data = await response.json();
                if (data && data.length > 0) {
                    return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                }
                return null;
            } catch (error) {
                console.warn("No se pudo geocodificar la direcci√≥n:", error.message);
                return null;
            }
        }
        
        async function reverseGeocode(lat, lon) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                if (!response.ok) throw new Error('Servicio de geocodificaci√≥n no disponible');
                const data = await response.json();
                return data.display_name || `${lat}, ${lon}`;
            } catch (error) {
                console.warn("No se pudo obtener la direcci√≥n:", error.message);
                return "No se pudo obtener la direcci√≥n.";
            }
        }

        function usarUbicacionActual() {
            if (!navigator.geolocation) return alert('La geolocalizaci√≥n no est√° soportada por tu navegador.');
            
            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;
                document.getElementById('latitudCliente').value = latitude;
                document.getElementById('longitudCliente').value = longitude;
                const direccion = await reverseGeocode(latitude, longitude);
                document.getElementById('direccionCliente').value = direccion;
                mostrarNotificacion('üìç Ubicaci√≥n actual obtenida.');
            }, (error) => {
                alert('No se pudo obtener tu ubicaci√≥n. Aseg√∫rate de dar los permisos necesarios.');
            });
        }

        function seleccionarUbicacionEnMapa() {
            abrirModalMapa(null, null, 'Selecciona la direcci√≥n de entrega', true, (lat, lon) => {
                document.getElementById('latitudCliente').value = lat;
                document.getElementById('longitudCliente').value = lon;
                reverseGeocode(lat, lon).then(direccion => {
                    document.getElementById('direccionCliente').value = direccion;
                });
                cerrarModalMapa();
            });
        }

        async function realizarPedido(event) {
            event.preventDefault();
            const btnPedido = document.getElementById('btnRealizarPedido');

            // Comprobar el bloqueo al inicio de la funci√≥n.
            if (btnPedido.disabled) {
                return;
            }

            // Bloquear la UI inmediatamente para prevenir clics dobles o re-intentos.
            btnPedido.disabled = true;
            btnPedido.textContent = 'Procesando pedido...';

            // Tomar una "foto" del estado actual del carrito y los datos del formulario.
            const cartParaPedido = [...carrito];
            const nombre = document.getElementById('nombreCliente').value;
            const telefono = document.getElementById('telefonoCliente').value;
            const email = document.getElementById('emailCliente').value || null;
            const direccion = document.getElementById('direccionCliente').value;
            let latitud = document.getElementById('latitudCliente').value;
            let longitud = document.getElementById('longitudCliente').value;

            if (cartParaPedido.length === 0) {
                mostrarNotificacion('‚ö†Ô∏è Tu carrito est√° vac√≠o.');
                btnPedido.disabled = false; // Desbloquear si no hay nada que procesar.
                btnPedido.textContent = 'Realizar Pedido';
                return;
            }

            // Acci√≥n at√≥mica y cr√≠tica: Vaciar el carrito principal.
            // A partir de este punto, cualquier otro llamado a esta funci√≥n encontrar√°
            // un carrito vac√≠o y no podr√° generar un pedido duplicado.
            carrito = [];
            actualizarContadorCarrito();

            try {
                // Realizar operaciones as√≠ncronas (que pueden tardar) de forma segura.
                if (!latitud || !longitud) {
                    const coords = await geocodeDireccion(direccion);
                    if (coords) {
                        latitud = coords.lat;
                        longitud = coords.lon;
                    }
                }
                
                const total = cartParaPedido.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
                const cantidad = cartParaPedido.reduce((sum, item) => sum + item.cantidad, 0);

                const pedidoData = {
                    nombre_cliente: nombre,
                    telefono_cliente: telefono,
                    email_cliente: email,
                    direccion: direccion,
                    productos: cartParaPedido.map(item => {
                        const productoOriginal = productos.find(p => p.id === item.id);
                        const costoUnitario = productoOriginal ? (productoOriginal.precio_costo || 0) : 0;
                        return {
                            id: item.id,
                            producto: item.nombre, 
                            marca: item.marca, 
                            cantidad: item.cantidad,
                            precio_unitario: parseFloat(item.precio),
                            costo_unitario: costoUnitario,
                            subtotal: parseFloat(item.precio) * item.cantidad,
                            variantes: item.variantes_seleccionadas
                        };
                    }),
                    total: parseFloat(total),
                    cantidad_items: cantidad,
                    estado: 'pendiente_pago',
                    latitud: latitud ? parseFloat(latitud) : null,
                    longitud: longitud ? parseFloat(longitud) : null,
                };
            
                const { data: pedidoGuardado, error } = await supabaseClient
                    .from('pedidos51')
                    .insert([pedidoData])
                    .select()
                    .single();

                if (error) throw error;
                
                try {
                    await fetch('https://webhook.red51.site/webhook/pedidos_red51', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(pedidoGuardado)
                    });
                } catch (webhookError) {
                    console.warn('El pedido se guard√≥, pero fall√≥ el env√≠o al webhook:', webhookError.message);
                }

                // √âxito: Mostrar mensaje de confirmaci√≥n. El formulario ya no es necesario.
                document.getElementById('cartContent').style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';

            } catch (error) {
                // En caso de error, restaurar el carrito a su estado original.
                carrito = cartParaPedido;
                actualizarContadorCarrito();
                // Volver a renderizar el formulario del carrito, lo que crear√° un nuevo bot√≥n habilitado.
                renderizarCarrito(); 
                alert('Error al realizar el pedido: ' + error.message);
            }
        }

        function cerrarYLimpiar() {
            cerrarCarrito();
            const cartContent = document.getElementById('cartContent');
            cartContent.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
            renderizarCarrito();
        }
        
        // --- ADMIN: Pedidos ---
        async function cargarPedidos() {
            if (!supabaseClient) return;
            try {
                const { data, error } = await supabaseClient
                    .from('pedidos51')
                    .select('*')
                    .order('fecha_pedido', { ascending: false });
                
                if (error) throw error;
                pedidos = data || [];
                renderizarFiltroEstados();
                renderizarPedidos();
            } catch (error) {
                console.error("Error al cargar pedidos:", error.message);
            }
        }

        function renderizarFiltroEstados() {
            const container = document.getElementById('pedidosFilterContainer');
            const estados = ['todos', ...estadosPosibles];
            container.innerHTML = estados.map(e => `
                <button class="filter-btn ${e === estadoPedidoActual ? 'active' : ''}" onclick="filtrarPedidosPorEstado('${e}')">
                    ${(e.charAt(0).toUpperCase() + e.slice(1)).replace(/_/g, ' ')}
                </button>
            `).join('');
        }

        function filtrarPedidosPorEstado(estado) {
            estadoPedidoActual = estado;
            renderizarFiltroEstados();
            renderizarPedidos();
        }

        function renderizarPedidos() {
            const pedidosFiltrados = estadoPedidoActual === 'todos'
                ? pedidos
                : pedidos.filter(p => p.estado === estadoPedidoActual);

            const ingresosTotales = pedidosFiltrados.reduce((sum, p) => sum + parseFloat(p.total), 0);
            const pedidosPendientes = pedidos.filter(p => p.estado === 'pendiente_pago' || p.estado === 'pago_confirmado' || p.estado === 'en_preparacion').length;
            
            document.getElementById('kpiIngresos').textContent = `S/ ${ingresosTotales.toFixed(2)}`;
            document.getElementById('kpiTotalPedidos').textContent = pedidos.length;
            document.getElementById('kpiPendientes').textContent = pedidosPendientes;
            const bajosStock = (inventario || []).filter(p => p.stock > 0 && p.stock <= 5).length;
            document.getElementById('kpiBajosStockPedidos').querySelector('.kpi-card-value').textContent = bajosStock;

            const tbody = document.getElementById('adminPedidosTable');
            if(pedidosFiltrados.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 2rem;">No hay pedidos con este estado.</td></tr>`;
                return;
            }
            tbody.innerHTML = pedidosFiltrados.map(p => `
                <tr data-id="${p.id}" onclick="verDetallesPedido('${p.id}')">
                    <td>${p.numero_pedido || 'N/A'}</td>
                    <td>${new Date(p.fecha_pedido).toLocaleDateString()}</td>
                    <td>${p.nombre_cliente}</td>
                    <td>S/ ${parseFloat(p.total).toFixed(2)}</td>
                    <td onclick="event.stopPropagation()">
                         <select class="status-select ${p.estado}" onchange="cambiarEstadoPedido('${p.id}', this.value)">
                            ${estadosPosibles.map(e => `<option value="${e}" ${e === p.estado ? 'selected' : ''}>${e.replace(/_/g, ' ')}</option>`).join('')}
                        </select>
                    </td>
                    <td onclick="event.stopPropagation()" style="text-align: center;">
                        ${p.latitud && p.longitud ? `
                            <button class="btn-secondary" style="padding: 0.5rem; font-size: 1.2rem; line-height: 1;" onclick="abrirModalMapa(${p.latitud}, ${p.longitud}, 'Ubicaci√≥n para: ${p.nombre_cliente}')">üó∫Ô∏è</button>
                        ` : `<span>-</span>`}
                    </td>
                </tr>
            `).join('');
        }

        async function verDetallesPedido(pedidoId) {
            try {
                const pedido = pedidos.find(p => p.id === pedidoId);
                if (!pedido) throw new Error('Pedido no encontrado');
                
                const modalBody = document.getElementById('pedidoModalBody');

                modalBody.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; flex-wrap: wrap;">
                        <div>
                            <h4>Datos del Cliente</h4>
                            <p><strong>Nombre:</strong> ${pedido.nombre_cliente}</p>
                            <p><strong>Tel√©fono:</strong> ${pedido.telefono_cliente}</p>
                            <p><strong>Email:</strong> ${pedido.email_cliente || 'No provisto'}</p>
                            <p><strong>Direcci√≥n:</strong> ${pedido.direccion}</p>
                        </div>
                        <div>
                            <h4>Resumen del Pedido</h4>
                            <p><strong>N¬∞ Pedido:</strong> ${pedido.numero_pedido || 'N/A'}</p>
                            <p><strong>Fecha:</strong> ${new Date(pedido.fecha_pedido).toLocaleString()}</p>
                            <p><strong>Total:</strong> S/ ${parseFloat(pedido.total).toFixed(2)}</p>
                            <div class="form-group" style="margin-top: 1rem;">
                                <label style="color: var(--text-dark);">Cambiar Estado</label>
                                <select id="modalStatusSelect" class="status-select ${pedido.estado}" onchange="cambiarEstadoPedido('${pedido.id}', this.value)">
                                    ${estadosPosibles.map(e => `<option value="${e}" ${e === pedido.estado ? 'selected' : ''}>${e.replace(/_/g, ' ')}</option>`).join('')}
                                </select>
                            </div>
                            ${pedido.latitud && pedido.longitud ? `
                                <div style="display: flex; gap: 0.5rem; width: 100%; margin-top: 1rem;">
                                    <button class="btn-secondary" style="flex: 1;" onclick="abrirModalMapa(${pedido.latitud}, ${pedido.longitud}, 'Ubicaci√≥n para: ${pedido.nombre_cliente}')">üó∫Ô∏è Ver en Mapa</button>
                                    <a href="https://maps.google.com/?q=${pedido.latitud},${pedido.longitud}" target="_blank" class="btn-secondary" style="flex: 1; text-align:center; text-decoration: none;">‚ÜóÔ∏è Abrir en GMaps</a>
                                </div>
                            ` : '<p style="margin-top: 1rem; color: var(--text-light);">Ubicaci√≥n no disponible.</p>'}
                        </div>
                    </div>
                    <h4 style="margin-top: 2rem; margin-bottom: 1rem;">Productos</h4>
                    ${(pedido.productos || []).map(p => {
                        const variantesStr = p.variantes ? ` <span class="cart-item-variants">${Object.entries(p.variantes).map(([k, v]) => `${k}: ${v}`).join(', ')}</span>` : '';
                        return `
                        <div class="cart-item" style="padding: 1rem;">
                           <div class="cart-item-info">
                                <div class="cart-item-name">${p.producto} (x${p.cantidad})</div>
                                <div class="cart-item-brand">${p.marca}</div>
                                ${variantesStr}
                           </div>
                           <div style="font-weight: 700; font-size: 1.1rem; color: var(--primary);">
                                S/ ${parseFloat(p.subtotal).toFixed(2)}
                           </div>
                        </div>
                    `}).join('')}
                `;
                document.getElementById('pedidoModal').classList.add('show');
                
                // Ensure the select inside the modal is correctly updated
                 const modalSelect = document.getElementById('modalStatusSelect');
                 if (modalSelect) modalSelect.value = pedido.estado;


            } catch (error) {
                alert("Error al cargar detalles del pedido: " + error.message);
            }
        }

        function cerrarModalPedido() {
             document.getElementById('pedidoModal').classList.remove('show');
        }

        async function cambiarEstadoPedido(pedidoId, nuevoEstado) {
            try {
                if (['pago_confirmado', 'en_preparacion'].includes(nuevoEstado)) {
                    const { error: rpcError } = await supabaseClient.rpc('descontar_stock_pedido', { id_pedido: pedidoId });
                    if (rpcError) {
                         throw new Error(`No se pudo procesar. ${rpcError.message}`);
                    }
                    mostrarNotificacion('üì¶ Stock descontado exitosamente con estrategia FEFO.');
                }
                
                const { error } = await supabaseClient
                    .from('pedidos51')
                    .update({ estado: nuevoEstado })
                    .eq('id', pedidoId);
                if (error) throw error;
                
                mostrarNotificacion(`‚úÖ Estado del pedido actualizado a: ${nuevoEstado.replace('_', ' ')}`);

                const pedidoIndex = pedidos.findIndex(p => p.id === pedidoId);
                if (pedidoIndex !== -1) {
                    pedidos[pedidoIndex].estado = nuevoEstado;
                    if (['pago_confirmado', 'en_preparacion'].includes(nuevoEstado)) {
                        pedidos[pedidoIndex].stock_descontado = true;
                    }
                }
                renderizarPedidos();
                
                await cargarProductosAdmin();
                await cargarProductos();
                await cargarInventario();

                const modalSelect = document.getElementById('modalStatusSelect');
                if (modalSelect) {
                    modalSelect.className = `status-select ${nuevoEstado}`;
                    modalSelect.value = nuevoEstado;
                }

            } catch(error) {
                alert("Error al actualizar el estado: " + error.message);
                await cargarPedidos(); // Recargar para revertir la UI a su estado real
            }
        }

        function suscribirACambiosPedidos() {
            if (pedidosChannel) {
                supabaseClient.removeChannel(pedidosChannel);
            }
            pedidosChannel = supabaseClient
                .channel('pedidos51-db-changes')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'pedidos51' },
                    (payload) => {
                        console.log('Cambio recibido en pedidos!', payload);
                        const changedRecord = payload.new;
                        const index = pedidos.findIndex(p => p.id === changedRecord.id);

                        if (payload.eventType === 'DELETE') {
                           if(index !== -1) pedidos.splice(index, 1);
                        } else if (index !== -1) {
                            pedidos[index] = { ...pedidos[index], ...changedRecord };
                        } else {
                            pedidos.unshift(changedRecord); // Add new orders to the top
                        }
                        
                        renderizarPedidos();
                        
                        setTimeout(() => {
                            const updatedRow = document.querySelector(`tr[data-id="${changedRecord.id}"]`);
                            if (updatedRow && payload.eventType !== 'DELETE') {
                                updatedRow.classList.add('row-updated');
                                setTimeout(() => updatedRow.classList.remove('row-updated'), 3000);
                            }
                        }, 0);
                    }
                )
                .subscribe();
        }

        function abrirModalMapa(lat, lon, title, isInteractive = false, onConfirm = null) {
            document.getElementById('mapModalTitle').textContent = title || 'Ubicaci√≥n de Entrega';
            document.getElementById('mapModal').classList.add('show');
            
            onMapaConfirmCallback = onConfirm;
            document.getElementById('mapaActions').style.display = isInteractive ? 'block' : 'none';
            
            setTimeout(() => {
                if (mapa) mapa.remove();
                
                const initialCoords = (lat && lon) ? [lat, lon] : [-12.046374, -77.042793]; // Default to Lima, Peru
                mapa = L.map('mapa').setView(initialCoords, 15);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '¬© OpenStreetMap'
                }).addTo(mapa);

                mapaMarker = L.marker(initialCoords, { draggable: isInteractive }).addTo(mapa);
                if (!isInteractive) {
                     mapaMarker.bindPopup(`<b>Entrega para:</b><br>${title.replace('Ubicaci√≥n para: ','')}`).openPopup();
                }
            }, 100);
        }

        function confirmarUbicacionDesdeMapa() {
            if (onMapaConfirmCallback && mapaMarker) {
                const { lat, lng } = mapaMarker.getLatLng();
                onMapaConfirmCallback(lat, lng);
            }
        }

        function cerrarModalMapa() {
            document.getElementById('mapModal').classList.remove('show');
            if (mapa) {
                mapa.remove();
                mapa = null;
                mapaMarker = null;
                onMapaConfirmCallback = null;
            }
        }


        // --- ADMIN: Productos y Categor√≠as ---
        async function cargarProductosAdmin() {
            if (!supabaseClient) return;
            document.getElementById('loadingAdmin').style.display = 'block';
            try {
                const { data, error } = await supabaseClient.from('productos51').select('*, categorias51(nombre)').order('nombre');
                if (error) throw error;
                
                productosAdmin = (data || []).map(p => ({
                    ...p,
                    categorias51: p.categorias51 ? { nombre: p.categorias51.nombre } : null
                }));

                renderizarProductosAdmin();
            } catch (error) {
                alert('Error al cargar productos: ' + error.message);
            } finally {
                document.getElementById('loadingAdmin').style.display = 'none';
            }
        }

        function renderizarProductosAdmin() {
            const tbody = document.getElementById('adminProductsTable');
            const searchTerm = document.getElementById('productSearchInput').value.toLowerCase();
            const clearBtn = document.getElementById('clearProductFilterBtn');
            const filterTitle = document.getElementById('productFilterTitle');

            let productosFiltrados = productosAdmin;

            if (isLowStockFilterActive) {
                productosFiltrados = productosFiltrados.filter(p => p.stock > 0 && p.stock <= 5);
                filterTitle.textContent = 'Mostrando productos con bajo stock (5 o menos unidades)';
                filterTitle.style.display = 'block';
            } else {
                 filterTitle.style.display = 'none';
            }
            
            if (searchTerm) {
                productosFiltrados = productosFiltrados.filter(p => 
                    p.nombre.toLowerCase().includes(searchTerm) || 
                    (p.marca && p.marca.toLowerCase().includes(searchTerm))
                );
            }
            
            if (isLowStockFilterActive || searchTerm) {
                clearBtn.style.display = 'inline-block';
            } else {
                clearBtn.style.display = 'none';
            }
            
            if (productosFiltrados.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 2rem;">No se encontraron productos con los filtros actuales.</td></tr>`;
                 return;
            }

            tbody.innerHTML = productosFiltrados.map(p => {
                let imagenPrincipal = p.imagen_url;
                if (p.variantes && p.variantes.length > 0) {
                    const primeraOpcionConImagen = p.variantes.flatMap(v => v.opciones || []).find(o => o.imagen_url);
                    if (primeraOpcionConImagen) imagenPrincipal = primeraOpcionConImagen.imagen_url;
                }

                return `
                <tr style="cursor: default;">
                    <td>${imagenPrincipal ? `<img src="${optimizarImagenUrl(imagenPrincipal, 50)}" alt="${p.nombre}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;" onerror="this.style.display='none'">` : '<span style="font-size: 0.8rem; color: #999;">Sin imagen</span>'}</td>
                    <td>${p.nombre}</td>
                    <td>${p.categorias51 ? p.categorias51.nombre : 'Sin categor√≠a'}</td>
                    <td>S/ ${parseFloat(p.precio).toFixed(2)}</td>
                    <td>${p.variantes && p.variantes.length > 0 ? `${p.variantes.length} tipo(s)` : 'No'}</td>
                    <td>${p.activo ? 'Activo' : 'Inactivo'}</td>
                    <td class="table-actions">
                        <button class="btn-edit" onclick="editarProducto(${p.id}, event)">Editar</button>
                        <button class="btn-danger" onclick="eliminarProducto(${p.id}, event)">Eliminar</button>
                    </td>
                </tr>`
            }).join('');
        }

        function verProductosBajosStock() {
            isLowStockFilterActive = true;
            mostrarVistaAdmin('productos');
            renderizarProductosAdmin();
        }

        function limpiarFiltroProductos() {
            document.getElementById('productSearchInput').value = '';
            isLowStockFilterActive = false;
            renderizarProductosAdmin();
        }
        
        async function cargarCategoriasAdmin() {
            if(!supabaseClient) return;
            try {
                const { data, error } = await supabaseClient.from('categorias51').select('*').order('nombre');
                if (error) throw error;
                const tbody = document.getElementById('adminCategoriesTable');
                tbody.innerHTML = (data || []).map(cat => `
                    <tr style="cursor: default;">
                        <td>${cat.nombre}</td>
                        <td>${cat.slug}</td>
                        <td class="table-actions">
                            <button class="btn-edit" onclick="editarCategoria(${cat.id}, event)">Editar</button>
                            <button class="btn-danger" onclick="eliminarCategoria(${cat.id}, event)">Eliminar</button>
                        </td>
                    </tr>`).join('');
            } catch (error) {
                alert('Error al cargar categor√≠as: ' + error.message);
            }
        }

        function abrirModalCategoria() {
            document.getElementById('categoriaModalTitle').textContent = 'Agregar Categor√≠a';
            const form = document.getElementById('categoriaForm');
            form.reset();
            document.getElementById('categoriaId').value = '';
            
            const saveBtn = document.getElementById('btnGuardarCategoria');
            saveBtn.disabled = true;
            saveBtn.title = 'No hay cambios para guardar';
            form.oninput = () => {
                saveBtn.disabled = false;
                saveBtn.title = '';
            };
            
            document.getElementById('categoriaModal').classList.add('show');
        }

        function cerrarModalCategoria() {
            document.getElementById('categoriaModal').classList.remove('show');
        }

        async function editarCategoria(id, event) {
            event.stopPropagation();
            try {
                const { data, error } = await supabaseClient.from('categorias51').select('*').eq('id', id).single();
                if (error) throw error;
                document.getElementById('categoriaModalTitle').textContent = 'Editar Categor√≠a';
                document.getElementById('categoriaId').value = data.id;
                document.getElementById('categoriaNombre').value = data.nombre;
                document.getElementById('categoriaSlug').value = data.slug;
                
                const form = document.getElementById('categoriaForm');
                const saveBtn = document.getElementById('btnGuardarCategoria');
                saveBtn.disabled = true;
                saveBtn.title = 'No hay cambios para guardar';
                form.oninput = () => {
                    saveBtn.disabled = false;
                    saveBtn.title = '';
                };
                
                document.getElementById('categoriaModal').classList.add('show');
            } catch (error) {
                alert('Error al cargar categor√≠a: ' + error.message);
            }
        }

        async function guardarCategoria(event) {
            event.preventDefault();
            const id = document.getElementById('categoriaId').value;
            const categoria = {
                nombre: document.getElementById('categoriaNombre').value,
                slug: document.getElementById('categoriaSlug').value,
            };

            try {
                if (id) {
                    const { error } = await supabaseClient.from('categorias51').update(categoria).eq('id', id);
                    if (error) throw error;
                    mostrarNotificacion('‚úÖ Categor√≠a actualizada');
                } else {
                    const { error } = await supabaseClient.from('categorias51').insert([categoria]);
                    if (error) throw error;
                    mostrarNotificacion('‚úÖ Categor√≠a creada');
                }
                cerrarModalCategoria();
                await cargarCategorias();
                cargarCategoriasAdmin();
            } catch (error) {
                alert('Error al guardar categor√≠a: ' + error.message);
            }
        }

        async function eliminarCategoria(id, event) {
            event.stopPropagation();
            if (!confirm('¬øEst√°s seguro? Eliminar una categor√≠a fallar√° si todav√≠a hay productos en ella.')) return;
            try {
                const { error } = await supabaseClient.from('categorias51').delete().eq('id', id);
                if (error) throw error;
                mostrarNotificacion('üóëÔ∏è Categor√≠a eliminada');
                await cargarCategorias();
                cargarCategoriasAdmin();
            } catch (error) {
                alert('Error al eliminar categor√≠a: ' + error.message);
            }
        }

        function generarSlug(text) {
            const slug = text.toString().toLowerCase()
                .replace(/\s+/g, '-') 
                .replace(/[^\w\-]+/g, '') 
                .replace(/\-\-+/g, '-') 
                .replace(/^-+/, '') 
                .replace(/-+$/, ''); 
            document.getElementById('categoriaSlug').value = slug;
        }

        function llenarSelectorCategoriasProducto() {
            const select = document.getElementById('productoCategoria');
            if (!select) return;
            if (categorias.length === 0) {
                select.innerHTML = '<option value="">Crea una categor√≠a primero</option>';
            } else {
                select.innerHTML = '<option value="">-- Selecciona --</option>' + categorias.map(cat => `<option value="${cat.id}">${cat.nombre}</option>`).join('');
            }
        }

        async function abrirModalProducto() {
            document.getElementById('productoModalTitle').textContent = 'Agregar Producto';
            const form = document.getElementById('productoForm');
            form.reset();
            document.getElementById('productoId').value = '';
            document.getElementById('productoActivo').checked = true;
            document.getElementById('productoGestionLote').checked = true;
            document.getElementById('variantesContainer').innerHTML = '';
            document.getElementById('variantImageFile').value = '';
            llenarSelectorCategoriasProducto();
            
            const saveBtn = document.getElementById('btnGuardarProducto');
            saveBtn.disabled = true;
            saveBtn.title = 'No hay cambios para guardar';
            form.oninput = () => {
                saveBtn.disabled = false;
                saveBtn.title = '';
            };

            document.getElementById('productoModal').classList.add('show');
        }

        function cerrarModalProducto() {
            document.getElementById('productoModal').classList.remove('show');
        }

        async function editarProducto(id, event) {
            event.stopPropagation();
            try {
                const { data, error } = await supabaseClient.from('productos51').select('*').eq('id', id).single();
                if (error) throw error;
                const form = document.getElementById('productoForm');
                
                document.getElementById('productoModalTitle').textContent = 'Editar Producto';
                document.getElementById('productoId').value = data.id;
                document.getElementById('productoNombre').value = data.nombre;
                document.getElementById('productoMarca').value = data.marca;
                document.getElementById('productoDescripcion').value = data.descripcion;
                document.getElementById('productoPrecio').value = data.precio;
                document.getElementById('productoCosto').value = data.precio_costo || 0;
                document.getElementById('productoIcon').value = data.icon || '';
                document.getElementById('productoBadge').value = data.badge || '';
                document.getElementById('productoActivo').checked = data.activo;
                document.getElementById('productoGestionLote').checked = data.gestiona_lotes;
                document.getElementById('productoImagen').value = data.imagen_url || '';
                
                llenarSelectorCategoriasProducto();
                document.getElementById('productoCategoria').value = data.categoria_id;
                
                renderizarVariantesForm(data.variantes);

                const saveBtn = document.getElementById('btnGuardarProducto');
                saveBtn.disabled = true;
                saveBtn.title = 'No hay cambios para guardar';
                form.oninput = () => {
                    saveBtn.disabled = false;
                    saveBtn.title = '';
                };

                document.getElementById('productoModal').classList.add('show');
            } catch (error) {
                alert('Error al cargar producto: ' + error.message);
            }
        }
        
        function agregarTipoVariante() {
            const container = document.getElementById('variantesContainer');
            const div = document.createElement('div');
            div.className = 'variante-group';
            div.innerHTML = `
                <div class="variante-header">
                    <input type="text" placeholder="Nombre de la Variante (ej: Color)" class="variante-nombre form-group" style="margin:0;">
                    <button type="button" class="btn-danger" onclick="this.parentElement.parentElement.remove()">√ó</button>
                </div>
                <div class="opciones-container">
                    <input type="text" class="form-group" style="margin:0; width: auto;" placeholder="A√±adir opci√≥n y presionar Enter" onkeydown="agregarOpcionVariante(event)">
                </div>
            `;
            container.appendChild(div);
        }

        function agregarOpcionVariante(event) {
            if (event.key !== 'Enter') return;
            event.preventDefault();
            const input = event.target;
            const valor = input.value.trim();
            if (!valor) return;

            const div = document.createElement('div');
            div.className = 'opcion-tag-enhanced';
            div.innerHTML = `
                <div class="opcion-image-preview" data-image-url="" onclick="seleccionarImagenVariante(this)">
                    <span>üñºÔ∏è</span>
                </div>
                <div class="opcion-details">
                    <span class="opcion-valor">${valor}</span>
                </div>
                <button type="button" onclick="this.parentElement.remove()">√ó</button>
            `;

            input.parentElement.insertBefore(div, input);
            input.value = '';
        }

        function renderizarVariantesForm(variantes) {
            const container = document.getElementById('variantesContainer');
            container.innerHTML = '';
            if (!variantes || !Array.isArray(variantes)) return;

            variantes.forEach(variante => {
                const div = document.createElement('div');
                div.className = 'variante-group';
                
                let opcionesHTML = (variante.opciones || []).map(opcion => {
                    const imageUrl = opcion.imagen_url || '';
                    const previewContent = imageUrl 
                        ? `<img src="${optimizarImagenUrl(imageUrl, 80)}" alt="${opcion.valor}">`
                        : `<span>üñºÔ∏è</span>`;
                    return `
                    <div class="opcion-tag-enhanced">
                        <div class="opcion-image-preview" data-image-url="${imageUrl}" onclick="seleccionarImagenVariante(this)">
                            ${previewContent}
                        </div>
                        <div class="opcion-details">
                            <span class="opcion-valor">${opcion.valor}</span>
                        </div>
                        <button type="button" onclick="this.parentElement.remove()">√ó</button>
                    </div>`;
                }).join('');

                div.innerHTML = `
                    <div class="variante-header">
                        <input type="text" placeholder="Nombre de la Variante" class="variante-nombre form-group" style="margin:0;" value="${variante.nombre || ''}">
                        <button type="button" class="btn-danger" onclick="this.parentElement.parentElement.remove()">√ó</button>
                    </div>
                    <div class="opciones-container">
                        ${opcionesHTML}
                        <input type="text" class="form-group" style="margin:0; width: auto;" placeholder="A√±adir opci√≥n..." onkeydown="agregarOpcionVariante(event)">
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function serializarVariantes() {
            const container = document.getElementById('variantesContainer');
            const variantes = [];
            container.querySelectorAll('.variante-group').forEach(group => {
                const nombre = group.querySelector('.variante-nombre').value.trim();
                if (!nombre) return;
                const opciones = [];
                group.querySelectorAll('.opcion-tag-enhanced').forEach(tag => {
                    const valor = tag.querySelector('.opcion-valor').textContent.trim();
                    const imagen_url = tag.querySelector('.opcion-image-preview').dataset.imageUrl || null;
                    if (valor) {
                        opciones.push({ valor, imagen_url });
                    }
                });

                if (opciones.length > 0) {
                    variantes.push({ nombre, opciones });
                }
            });
            return variantes.length > 0 ? variantes : null;
        }

        async function guardarProducto(event) {
            event.preventDefault();
            const id = document.getElementById('productoId').value;
            const categoriaIdValue = document.getElementById('productoCategoria').value;

            const producto = {
                nombre: document.getElementById('productoNombre').value,
                marca: document.getElementById('productoMarca').value,
                categoria_id: categoriaIdValue ? parseInt(categoriaIdValue) : null,
                descripcion: document.getElementById('productoDescripcion').value,
                precio: parseFloat(document.getElementById('productoPrecio').value),
                precio_costo: parseFloat(document.getElementById('productoCosto').value),
                icon: document.getElementById('productoIcon').value || 'üçî',
                badge: document.getElementById('productoBadge').value || null,
                activo: document.getElementById('productoActivo').checked,
                gestiona_lotes: document.getElementById('productoGestionLote').checked,
                imagen_url: document.getElementById('productoImagen').value || null,
                variantes: serializarVariantes(),
            };
            
            try {
                if (id) {
                    const { error } = await supabaseClient.from('productos51').update(producto).eq('id', id);
                    if (error) throw error;
                    mostrarNotificacion('‚úÖ Producto actualizado exitosamente');
                } else {
                    const { error } = await supabaseClient.from('productos51').insert([producto]);
                    if (error) throw error;
                    mostrarNotificacion('‚úÖ Producto creado exitosamente');
                }
                cerrarModalProducto();
                await cargarProductosAdmin();
                await cargarProductos();
                await cargarInventario();
            } catch (error) {
                let friendlyMessage = 'Error al guardar producto: ' + error.message;
                const lowerCaseError = error.message.toLowerCase();

                if (lowerCaseError.includes("column \"precio_costo\" does not exist") || lowerCaseError.includes("could not find the 'precio_costo' column")) {
                     friendlyMessage = `¬°Error de Sincronizaci√≥n de Base de Datos!\n\nLa columna 'precio_costo' no existe en tu tabla de productos. Esto ocurre porque la aplicaci√≥n fue actualizada para incluir el c√°lculo de ganancias, pero tu base de datos a√∫n no ha sido actualizada.\n\n‚úÖ SOLUCI√ìN SENCILLA:\n1. Ve a la pesta√±a "Ayuda" en el panel de administrador.\n2. Busca la secci√≥n "Herramientas para Desarrolladores".\n3. Copia el script completo llamado "Script de Sincronizaci√≥n de Base de Datos".\n4. P√©galo y ejec√∫talo en el "SQL Editor" de tu proyecto en Supabase.\n\nEsto actualizar√° tu base de datos de forma segura sin borrar datos y solucionar√° el problema permanentemente.`;
                } else if (error.message && error.message.includes('violates not-null constraint') && error.message.includes('"categoria"')) {
                    friendlyMessage += `\n\n[POSIBLE SOLUCI√ìN] Este error suele ocurrir si la base de datos es de una versi√≥n anterior. Ve a Admin -> Ayuda -> Herramientas para Desarrolladores, copia el script completo y ejec√∫talo en el "SQL Editor" de tu Supabase para sincronizar la base de datos.`;
                }
                alert(friendlyMessage);
            }
        }

        async function eliminarProducto(id, event) {
            event.stopPropagation();
            if (!confirm('¬øEst√°s seguro de eliminar este producto? Esta acci√≥n tambi√©n eliminar√° todos sus lotes de inventario y movimientos asociados.')) return;
            try {
                const { error } = await supabaseClient.from('productos51').delete().eq('id', id);
                if (error) throw error;
                mostrarNotificacion('üóëÔ∏è Producto eliminado exitosamente');
                await cargarProductosAdmin();
                await cargarProductos();
                await cargarInventario();
            } catch (error) {
                alert('Error al eliminar producto: ' + error.message);
            }
        }
        
        // --- ADMIN: Inventario y Movimientos ---
        async function cargarInventario() {
            if (!supabaseClient) return;
            try {
                const { data, error } = await supabaseClient.from('productos51').select('id, nombre, stock, precio_costo').order('nombre');
                if (error) throw error;
                inventario = data || [];
                renderizarInventario();
                calcularKPIsInventario();
            } catch (error) {
                console.error("Error al cargar inventario:", error.message);
            }
        }

        function calcularKPIsInventario() {
            const valorTotal = inventario.reduce((sum, p) => sum + (p.stock * (p.precio_costo || 0)), 0);
            const unidadesTotales = inventario.reduce((sum, p) => sum + p.stock, 0);
            const bajosStock = inventario.filter(p => p.stock > 0 && p.stock <= 5).length;
            const sinStock = inventario.filter(p => p.stock === 0).length;

            document.getElementById('kpiValorInventario').textContent = `S/ ${valorTotal.toFixed(2)}`;
            document.getElementById('kpiUnidadesTotales').textContent = unidadesTotales;
            document.getElementById('kpiBajosStockInventario').textContent = bajosStock;
            document.getElementById('kpiSinStock').textContent = sinStock;
        }

        function renderizarInventario() {
            const tbody = document.getElementById('inventarioTableBody');
            const searchTerm = document.getElementById('inventorySearchInput').value.toLowerCase();
            const productosFiltrados = inventario.filter(p => p.nombre.toLowerCase().includes(searchTerm));

            if (productosFiltrados.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 2rem;">No se encontraron productos.</td></tr>`;
                return;
            }

            tbody.innerHTML = productosFiltrados.map(p => `
                <tr class="clickable" onclick="verMovimientos(${p.id}, '${p.nombre.replace(/'/g, "\\'")}')">
                    <td>${p.nombre}</td>
                    <td style="font-weight: 600; color: ${p.stock <= 5 ? (p.stock === 0 ? 'var(--danger)' : 'var(--warning)') : 'var(--text-dark)'};">${p.stock}</td>
                    <td>S/ ${(p.stock * (p.precio_costo || 0)).toFixed(2)}</td>
                    <td class="table-actions" onclick="event.stopPropagation();">
                        <button class="btn-lotes" onclick="abrirModalIngresoStock(${p.id}, event)">+ Registrar Ingreso</button>
                    </td>
                </tr>
            `).join('');
        }

        async function verMovimientos(productoId, nombreProducto) {
            mostrarVistaAdmin('movimientos');
            document.getElementById('movimientosTitle').textContent = `Historial de Movimientos para: ${nombreProducto}`;
            const tbody = document.getElementById('movimientosTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="loading">Cargando historial...</td></tr>';
            try {
                const { data, error } = await supabaseClient
                    .from('movimientos_inventario51')
                    .select('*')
                    .eq('producto_id', productoId)
                    .order('fecha_movimiento', { ascending: false });

                if (error) throw error;
                movimientos = data || [];
                renderizarMovimientos();
            } catch (error) {
                 tbody.innerHTML = `<tr><td colspan="6" class="error-info">${error.message}</td></tr>`;
            }
        }

        function renderizarMovimientos() {
            const tbody = document.getElementById('movimientosTableBody');
            if (movimientos.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 2rem;">No hay movimientos registrados para este producto.</td></tr>`;
                return;
            }

            tbody.innerHTML = movimientos.map(m => {
                const esIngreso = m.tipo_movimiento.startsWith('INGRESO');
                return `
                <tr>
                    <td>${new Date(m.fecha_movimiento).toLocaleString()}</td>
                    <td class="movimiento-tipo ${esIngreso ? 'ingreso' : 'salida'}">${m.tipo_movimiento.replace(/_/g, ' ')}</td>
                    <td style="font-weight: 600;">${m.cantidad}</td>
                    <td>${m.stock_resultante}</td>
                    <td>${m.usuario_email || 'Sistema'}</td>
                    <td>${m.referencia_id || 'N/A'}</td>
                </tr>
                `
            }).join('');
        }
        
        async function abrirModalIngresoStock(productoId, event) {
            event.stopPropagation();
            const producto = productosAdmin.find(p => p.id == productoId);
            if (!producto) {
                alert("Producto no encontrado. Por favor, recarga la p√°gina.");
                return;
            }
            
            // Adaptar modal din√°micamente
            const gestionaLotes = producto.gestiona_lotes;
            document.getElementById('ingresoStockModalTitle').textContent = gestionaLotes ? 'Registrar Ingreso de Stock' : `Registrar Ingreso: ${producto.nombre}`;
            document.getElementById('lotesContainerTitle').style.display = gestionaLotes ? 'block' : 'none';
            document.getElementById('btnAddLote').style.display = gestionaLotes ? 'inline-block' : 'none';

            document.getElementById('ingresoProductoId').value = productoId;
            document.getElementById('ingresoStockForm').reset();
            const container = document.getElementById('lotesParaIngresarContainer');
            container.innerHTML = '';
            agregarLoteParaIngreso(gestionaLotes);
            document.getElementById('ingresoStockModal').classList.add('show');
        }

        function cerrarModalIngresoStock() {
            document.getElementById('ingresoStockModal').classList.remove('show');
        }

        function agregarLoteParaIngreso(gestionaLotes = true) {
            const container = document.getElementById('lotesParaIngresarContainer');
            const div = document.createElement('div');
            div.className = 'lote-item lote-ingreso-item';
            
            if (gestionaLotes) {
                div.style.gridTemplateColumns = '1fr 1fr 1fr auto';
                div.innerHTML = `
                    <div class="form-group" style="margin: 0;"><label>N¬∞ Lote</label><input type="text" class="loteNumeroIngreso"></div>
                    <div class="form-group" style="margin: 0;"><label>Vencimiento</label><input type="date" class="loteFechaIngreso"></div>
                    <div class="form-group" style="margin: 0;"><label>Cantidad</label><input type="number" min="1" class="loteCantidadIngreso" required></div>
                    <button type="button" class="btn-danger" style="align-self: end; margin-bottom: 1rem;" onclick="this.parentElement.remove()">√ó</button>
                `;
            } else {
                // Simplificado para productos sin lote
                div.style.gridTemplateColumns = '1fr';
                div.innerHTML = `
                    <div class="form-group" style="margin: 0;"><label>Cantidad a Ingresar</label><input type="number" min="1" class="loteCantidadIngreso" required></div>
                `;
            }
            container.appendChild(div);
        }

        function agregarLoteParaIngresoDesdeBoton() {
            const productoId = document.getElementById('ingresoProductoId').value;
            const producto = productosAdmin.find(p => p.id == productoId);
            agregarLoteParaIngreso(producto ? producto.gestiona_lotes : true);
        }

        async function registrarIngresoStock(event) {
            event.preventDefault();
            const productoId = document.getElementById('ingresoProductoId').value;
            const comprobante = document.getElementById('ingresoComprobante').value;
            const proveedor = document.getElementById('ingresoProveedor').value;
            
            const lotes = [];
            document.querySelectorAll('.lote-ingreso-item').forEach(item => {
                const cantidadInput = item.querySelector('.loteCantidadIngreso');
                const cantidad = cantidadInput ? cantidadInput.value : null;

                if (cantidad && parseInt(cantidad) > 0) {
                    const loteNumeroInput = item.querySelector('.loteNumeroIngreso');
                    const fechaIngresoInput = item.querySelector('.loteFechaIngreso');

                    lotes.push({
                        numero_lote: loteNumeroInput ? loteNumeroInput.value || null : `SINLOTE-${Date.now()}`,
                        fecha_vencimiento: fechaIngresoInput ? fechaIngresoInput.value || null : null,
                        cantidad: parseInt(cantidad)
                    });
                }
            });

            if (lotes.length === 0) {
                alert("Debes a√±adir al menos un item con una cantidad mayor a cero.");
                return;
            }

            try {
                const { error } = await supabaseClient.rpc('registrar_ingreso_stock', {
                    id_producto: productoId,
                    lotes: lotes,
                    comprobante: comprobante,
                    prov: proveedor
                });

                if (error) throw error;

                mostrarNotificacion('‚úÖ Ingreso de stock registrado con √©xito.');
                cerrarModalIngresoStock();
                await cargarInventario();
                await cargarProductos();
            } catch (error) {
                alert("Error al registrar el ingreso: " + error.message);
            }
        }

        function seleccionarImagenVariante(previewElement) {
            currentVariantPreviewElement = previewElement;
            document.getElementById('variantImageFile').click();
        }

        async function subirImagenVariante(event) {
            const file = event.target.files[0];
            if (!file || !currentVariantPreviewElement) return;

            currentVariantPreviewElement.innerHTML = `<div style="width: 100%; height: 4px; background: var(--secondary); animation: pulse 1s infinite;"></div>`;

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
                const data = await response.json();

                if (!response.ok) throw new Error(data.error.message || 'Error desconocido desde Cloudinary.');

                const imageUrl = data.secure_url;
                currentVariantPreviewElement.dataset.imageUrl = imageUrl;
                currentVariantPreviewElement.innerHTML = `<img src="${optimizarImagenUrl(imageUrl, 100)}" alt="Preview">`;
                mostrarNotificacion('üñºÔ∏è Imagen de variante asignada.');

            } catch (error) {
                let friendlyMessage = 'Error al subir la imagen: ' + error.message;
                if (error.message && (error.message.includes('upload preset') || error.message.includes('not found'))) {
                    friendlyMessage += `\n\n‚û°Ô∏è Soluci√≥n: Verifica que el "upload_preset" ('${CLOUDINARY_UPLOAD_PRESET}') exista en tu cuenta de Cloudinary y que su modo sea "Unsigned". Revisa la secci√≥n de Ayuda para m√°s detalles.`;
                } else if (error.message && error.message.includes('cloud_name')) {
                    friendlyMessage += `\n\n‚û°Ô∏è Soluci√≥n: Verifica que el "cloud_name" ('${CLOUDINARY_CLOUD_NAME}') sea correcto.`;
                }
                alert(friendlyMessage);
                currentVariantPreviewElement.innerHTML = '<span>üñºÔ∏è</span>';
            } finally {
                event.target.value = '';
                currentVariantPreviewElement = null;
            }
        }

        function optimizarImagenUrl(url, width = 600) {
            if (url && url.includes('res.cloudinary.com') && !url.includes('/upload/c_')) {
                const parts = url.split('/upload/');
                if (parts.length === 2) {
                    return `${parts[0]}/upload/c_fill,g_auto,q_auto,f_auto,w_${width}/${parts[1]}`;
                }
            }
            return url;
        }

        function descargarPlantilla() {
            const data = [
                ["nombre", "marca", "categoria_id", "descripcion", "precio", "precio_costo", "icon", "badge", "activo", "gestiona_lotes"],
                ["Hamburguesa Cl√°sica", "Cl√°sicas", 1, "Pan artesanal, carne 100% res, queso cheddar, lechuga, tomate, cebolla y mayonesa especial.", 15.00, 7.50, "üçî", "Popular", true, true],
                ["Hamburguesa BBQ", "Especiales", 1, "Carne de res a la parrilla con tocino crocante, queso, cebolla caramelizada y salsa BBQ.", 22.00, 11.00, "üçî", "Nuevo", true, true],
                ["Hamburguesa de Pollo Crispy", "Pollo", 1, "Filete de pollo empanizado, lechuga, tomate y mayonesa con toque de ajo.", 18.00, 9.00, "üêî", "", true, true],
                ["Papas Fritas Cl√°sicas", "Acompa√±amientos", 2, "Papas naturales crocantes, servidas con ketchup o mayonesa.", 8.00, 3.00, "üçü", "", true, false],
                ["Aros de Cebolla", "Acompa√±amientos", 2, "Cebollas empanizadas y fritas hasta dorar, servidas con salsa t√°rtara.", 10.00, 4.00, "üßÖ", "", true, false],
                ["Alitas BBQ", "Acompa√±amientos", 2, "6 jugosas alitas de pollo ba√±adas en nuestra salsa BBQ secreta.", 18.00, 9.00, "üçó", "", true, true],
                ["Inca Kola Personal", "Bebidas", 3, "Gaseosa personal de 500ml, el sabor del Per√∫.", 5.00, 2.50, "ü•§", "", true, false],
                ["Chicha Morada", "Bebidas", 3, "Refresco tradicional con toque casero, vaso de 500ml.", 6.00, 2.00, "ü•§", "", true, false],
                ["Brownie con Helado", "Postres", 4, "Brownie de chocolate caliente con una bola de helado de vainilla y fudge.", 12.00, 5.00, "üç∞", "", true, false],
                ["Combo Cl√°sico", "Combos", 5, "Hamburguesa cl√°sica + papas fritas cl√°sicas + gaseosa personal.", 25.00, 12.00, "üçî", "Ahorro", true, false]
            ];
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Productos");
            XLSX.writeFile(wb, "plantilla_productos_pedidos51.xlsx");
            mostrarNotificacion('üì• Plantilla de Excel (.xlsx) descargada. Aseg√∫rate de crear las categor√≠as primero. El stock se gestiona desde el M√≥dulo de Inventario.');
        }

        async function importarProductos(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    document.getElementById('loadingAdmin').style.display = 'block';
                    let productosImportados = [];
                    const fileContent = e.target.result;

                    if (file.name.endsWith('.csv')) {
                        const lines = fileContent.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim());
                        productosImportados = lines.slice(1).map(line => {
                            if (!line.trim()) return null;
                            const values = line.split(',').map(v => v.trim());
                            const producto = {};
                            headers.forEach((header, i) => producto[header] = values[i] || null);
                            return producto;
                        }).filter(Boolean);
                    } else { // Handle .xls, .xlsx
                        const workbook = XLSX.read(fileContent, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        productosImportados = XLSX.utils.sheet_to_json(worksheet);
                    }

                    if (productosImportados.length === 0) {
                         throw new Error('No se encontraron productos v√°lidos en el archivo.');
                    }
                    
                    const productosParaSupabase = productosImportados.map(p => ({
                        nombre: p.nombre,
                        marca: p.marca,
                        categoria_id: p.categoria_id ? parseInt(p.categoria_id) : null,
                        descripcion: p.descripcion,
                        precio: p.precio ? parseFloat(p.precio) : 0,
                        precio_costo: p.precio_costo ? parseFloat(p.precio_costo) : 0,
                        stock: 0, // El stock ahora se gestiona por lotes
                        icon: p.icon,
                        badge: p.badge,
                        activo: String(p.activo).toLowerCase() === 'true',
                        gestiona_lotes: p.gestiona_lotes === undefined ? true : String(p.gestiona_lotes).toLowerCase() === 'true'
                    })).filter(p => p.nombre && p.marca && p.categoria_id && p.precio);
                    
                    if (productosParaSupabase.length === 0) {
                        throw new Error('Los productos en el archivo no tienen el formato correcto (nombre, marca, categoria_id y precio son requeridos).');
                    }
                    
                    if (!confirm(`Se importar√°n ${productosParaSupabase.length} productos. Recuerda registrar sus ingresos de stock desde el M√≥dulo de Inventario. ¬øContinuar?`)) {
                         document.getElementById('loadingAdmin').style.display = 'none';
                         return;
                    }

                    const { error } = await supabaseClient.from('productos51').insert(productosParaSupabase);
                    if (error) throw error;
                    
                    mostrarNotificacion(`‚úÖ ${productosParaSupabase.length} productos importados exitosamente.`);
                    await cargarProductosAdmin();
                    await cargarProductos();
                    await cargarInventario();
                } catch (error) {
                    alert('Error al importar productos: ' + error.message);
                } finally {
                    document.getElementById('loadingAdmin').style.display = 'none';
                    event.target.value = '';
                }
            };
            
            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }
        
        // --- ADMIN: Importaci√≥n de Stock ---
        function descargarPlantillaStock() {
            const data = [
                ["nombre_producto", "cantidad", "numero_lote", "fecha_vencimiento", "factura_compra", "proveedor"],
                ["Hamburguesa Cl√°sica", 50, "CARNE-LOTE-001", "2025-12-31", "F001-123", "Proveedor de Carnes"],
                ["Hamburguesa BBQ", 50, "CARNE-LOTE-002", "2025-12-31", "F001-123", "Proveedor de Carnes"],
                ["Papas Fritas", 100, "", "", "F001-124", "Proveedor de Papas"],
                ["Inca Kola Personal", 200, "", "", "F001-125", "Distribuidor de Bebidas"],
                ["Alitas BBQ", 30, "POLLO-LOTE-A", "2025-12-20", "F001-126", "Proveedor Av√≠cola"]
            ];
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Stock");
            XLSX.writeFile(wb, "plantilla_ingreso_stock.xlsx");
            mostrarNotificacion('üì• Plantilla de stock descargada. "numero_lote" y "fecha_vencimiento" son opcionales.');
        }

        async function importarStock(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    document.getElementById('loadingAdmin').style.display = 'block';
                    const fileContent = e.target.result;
                    let stockItems;

                    if (file.name.endsWith('.csv')) {
                        const lines = fileContent.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim());
                        stockItems = lines.slice(1).map(line => {
                            if (!line.trim()) return null;
                            const values = line.split(',').map(v => v.trim());
                            const item = {};
                            headers.forEach((header, i) => item[header] = values[i] || null);
                            return item;
                        }).filter(Boolean);
                    } else {
                        const workbook = XLSX.read(fileContent, { type: 'array', cellDates: true });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        stockItems = XLSX.utils.sheet_to_json(worksheet);
                    }

                    if (stockItems.length === 0) throw new Error('No se encontraron items de stock en el archivo.');

                    const productosPorProcesar = {};
                    const productosNoEncontrados = new Set();
                    let itemsValidos = 0;

                    for (const item of stockItems) {
                        const nombre = item.nombre_producto;
                        const cantidad = parseInt(item.cantidad);

                        if (!nombre || !cantidad || isNaN(cantidad)) continue;
                        
                        itemsValidos++;
                        const producto = productosAdmin.find(p => p.nombre.toLowerCase() === nombre.toLowerCase());

                        if (!producto) {
                            productosNoEncontrados.add(nombre);
                            continue;
                        }

                        if (!productosPorProcesar[producto.id]) {
                            productosPorProcesar[producto.id] = {
                                producto: producto,
                                lotes: [],
                                comprobante: item.factura_compra || `IMPORT-${new Date().toISOString().split('T')[0]}`,
                                proveedor: item.proveedor || 'Importaci√≥n Masiva'
                            };
                        }
                        
                        // Si la fecha es un objeto Date de xlsx, la formateamos
                        let fechaVencimiento = item.fecha_vencimiento || null;
                        if (fechaVencimiento instanceof Date) {
                            fechaVencimiento = fechaVencimiento.toISOString().split('T')[0];
                        }

                        productosPorProcesar[producto.id].lotes.push({
                            numero_lote: producto.gestiona_lotes ? (item.numero_lote || null) : `SINLOTE-${Date.now()}`,
                            fecha_vencimiento: producto.gestiona_lotes ? (fechaVencimiento || null) : null,
                            cantidad: cantidad
                        });
                    }
                    
                    const numProductosAfectados = Object.keys(productosPorProcesar).length;
                    if (numProductosAfectados === 0) {
                        throw new Error(`De ${itemsValidos} items v√°lidos, no se encontr√≥ ning√∫n producto correspondiente en la base de datos. Productos no encontrados: ${Array.from(productosNoEncontrados).join(', ')}`);
                    }

                    if (!confirm(`Se procesar√°n ingresos de stock para ${numProductosAfectados} producto(s) diferente(s). ${productosNoEncontrados.size > 0 ? `${productosNoEncontrados.size} producto(s) no fueron encontrados y ser√°n omitidos.` : ''} ¬øDeseas continuar?`)) {
                        return;
                    }

                    const promesas = Object.values(productosPorProcesar).map(data => 
                        supabaseClient.rpc('registrar_ingreso_stock', {
                            id_producto: data.producto.id,
                            lotes: data.lotes,
                            comprobante: data.comprobante,
                            prov: data.proveedor
                        })
                    );
                    
                    await Promise.all(promesas);

                    let mensajeFinal = `‚úÖ Importaci√≥n completada. Se actualiz√≥ el stock para ${numProductosAfectados} producto(s).`;
                    if (productosNoEncontrados.size > 0) {
                        mensajeFinal += `\n\n‚ö†Ô∏è Productos no encontrados y omitidos: ${Array.from(productosNoEncontrados).join(', ')}. Por favor, cr√©alos en la pesta√±a 'Productos' antes de importar su stock.`;
                    }
                    alert(mensajeFinal);

                    await cargarInventario();
                    await cargarProductos();

                } catch (error) {
                    alert('Error durante la importaci√≥n de stock: ' + error.message);
                } finally {
                     document.getElementById('loadingAdmin').style.display = 'none';
                     event.target.value = ''; // Reset file input
                }
            };

            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }
        
        // --- ADMIN: Reportes (NUEVA ESTRUCTURA) ---

        function inicializarReportes() {
            const hoy = new Date();
            const haceUnMes = new Date();
            haceUnMes.setMonth(haceUnMes.getMonth() - 1);
            const hoyStr = hoy.toISOString().split('T')[0];
            const haceUnMesStr = haceUnMes.toISOString().split('T')[0];

            // Fechas para Resumen
            document.getElementById('reporteFechaInicio').value = haceUnMesStr;
            document.getElementById('reporteFechaFin').value = hoyStr;
            // Fechas para Ventas por Producto
            document.getElementById('reporteProductoFechaInicio').value = haceUnMesStr;
            document.getElementById('reporteProductoFechaFin').value = hoyStr;
            // Fechas para Compras
            document.getElementById('reporteComprasFechaInicio').value = haceUnMesStr;
            document.getElementById('reporteComprasFechaFin').value = hoyStr;

            // Llenar selector de productos
            const selector = document.getElementById('reporteProductoSelect');
            if (productosAdmin.length > 0) {
                selector.innerHTML = '<option value="">-- Todos los productos --</option>' + 
                    productosAdmin.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
            } else {
                selector.innerHTML = '<option value="">No hay productos</option>';
            }
        }

        function mostrarSubVistaReporte(vista) {
            document.querySelectorAll('.reporte-subview').forEach(v => v.style.display = 'none');
            document.querySelectorAll('#reportesNav .admin-nav-btn').forEach(b => b.classList.remove('active'));

            document.getElementById(`reporte${vista.charAt(0).toUpperCase() + vista.slice(1)}View`).style.display = 'block';
            document.getElementById(`navBtn${vista.charAt(0).toUpperCase() + vista.slice(1)}`).classList.add('active');
        }

        async function generarReporteVentas() {
            // Esta funci√≥n ahora solo controla el reporte de Resumen
            const fechaInicio = document.getElementById('reporteFechaInicio').value;
            const fechaFin = document.getElementById('reporteFechaFin').value;
            
            if (!fechaInicio || !fechaFin) {
                alert("Por favor, selecciona un rango de fechas.");
                return;
            }

            const fechaFinCompleta = new Date(fechaFin);
            fechaFinCompleta.setHours(23, 59, 59, 999);

            try {
                document.getElementById('loadingAdmin').style.display = 'block';
                const { data, error } = await supabaseClient
                    .from('pedidos51')
                    .select('*')
                    .gte('fecha_pedido', new Date(fechaInicio).toISOString())
                    .lte('fecha_pedido', fechaFinCompleta.toISOString())
                    .order('fecha_pedido', { ascending: false });

                if (error) throw error;
                
                const pedidosFiltrados = data || [];
                datosReporteActual = [];
                let totalIngresos = 0;
                let totalCosto = 0;

                pedidosFiltrados.forEach(pedido => {
                    (pedido.productos || []).forEach(item => {
                        const costoUnitario = item.costo_unitario || 0;
                        const costoTotalItem = costoUnitario * item.cantidad;
                        const gananciaItem = item.subtotal - costoTotalItem;

                        totalIngresos += item.subtotal;
                        totalCosto += costoTotalItem;
                        
                        datosReporteActual.push({
                            numero_pedido: pedido.numero_pedido,
                            fecha: new Date(pedido.fecha_pedido).toLocaleDateString(),
                            cliente: pedido.nombre_cliente,
                            producto: item.producto,
                            cantidad: item.cantidad,
                            total_venta: item.subtotal,
                            costo_total: costoTotalItem,
                            ganancia: gananciaItem
                        });
                    });
                });
                
                const gananciaBruta = totalIngresos - totalCosto;
                const margenGanancia = totalIngresos > 0 ? (gananciaBruta / totalIngresos) * 100 : 0;

                document.getElementById('reporteKpiIngresos').textContent = `S/ ${totalIngresos.toFixed(2)}`;
                document.getElementById('reporteKpiCosto').textContent = `S/ ${totalCosto.toFixed(2)}`;
                document.getElementById('reporteKpiGanancia').textContent = `S/ ${gananciaBruta.toFixed(2)}`;
                document.getElementById('reporteKpiMargen').textContent = `${margenGanancia.toFixed(2)} %`;
                
                renderizarReporteTabla();

            } catch (error) {
                alert('Error al generar el reporte: ' + error.message);
            } finally {
                document.getElementById('loadingAdmin').style.display = 'none';
            }
        }
        
        function renderizarReporteTabla() {
            const tbody = document.getElementById('reportesTableBody');
            if (datosReporteActual.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 2rem;">No se encontraron ventas en el per√≠odo seleccionado.</td></tr>`;
                return;
            }
            
            tbody.innerHTML = datosReporteActual.map(item => `
                <tr>
                    <td>${item.numero_pedido}</td>
                    <td>${item.fecha}</td>
                    <td>${item.cliente}</td>
                    <td>${item.producto}</td>
                    <td>${item.cantidad}</td>
                    <td>S/ ${item.total_venta.toFixed(2)}</td>
                    <td>S/ ${item.costo_total.toFixed(2)}</td>
                    <td style="font-weight: 600; color: ${item.ganancia >= 0 ? 'var(--success)' : 'var(--danger)'};">S/ ${item.ganancia.toFixed(2)}</td>
                </tr>
            `).join('');
        }

        async function generarReporteVentasPorProducto() {
            const productoId = document.getElementById('reporteProductoSelect').value;
            const fechaInicio = document.getElementById('reporteProductoFechaInicio').value;
            const fechaFin = document.getElementById('reporteProductoFechaFin').value;
            const tbody = document.getElementById('reporteVentasPorProductoTableBody');
            
            if (!fechaInicio || !fechaFin) {
                alert("Por favor, selecciona un rango de fechas.");
                return;
            }

            tbody.innerHTML = `<tr><td colspan="5" class="loading">Generando reporte...</td></tr>`;

            const fechaFinCompleta = new Date(fechaFin);
            fechaFinCompleta.setHours(23, 59, 59, 999);

            try {
                const { data, error } = await supabaseClient
                    .from('pedidos51')
                    .select('fecha_pedido, numero_pedido, nombre_cliente, productos')
                    .gte('fecha_pedido', new Date(fechaInicio).toISOString())
                    .lte('fecha_pedido', fechaFinCompleta.toISOString())
                    .order('fecha_pedido', { ascending: false });

                if (error) throw error;

                const ventasFiltradas = [];
                (data || []).forEach(pedido => {
                    (pedido.productos || []).forEach(item => {
                        if (!productoId || item.id == productoId) {
                            ventasFiltradas.push({
                                fecha: new Date(pedido.fecha_pedido).toLocaleDateString(),
                                numero_pedido: pedido.numero_pedido,
                                cliente: pedido.nombre_cliente,
                                cantidad: item.cantidad,
                                total: item.subtotal,
                                producto_nombre: item.producto // Para el caso "Todos"
                            });
                        }
                    });
                });
                
                if(ventasFiltradas.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 2rem;">No se encontraron ventas para este producto en el per√≠odo seleccionado.</td></tr>`;
                    return;
                }
                
                // Si el filtro es para todos, se a√±ade la columna producto
                const allProductsMode = !productoId;
                if(allProductsMode) {
                   tbody.parentElement.querySelector('thead tr').innerHTML = `<th>Fecha</th><th>Producto</th><th>N¬∞ Pedido</th><th>Cliente</th><th>Cantidad</th><th>Total Venta</th>`;
                } else {
                   tbody.parentElement.querySelector('thead tr').innerHTML = `<th>Fecha</th><th>N¬∞ Pedido</th><th>Cliente</th><th>Cantidad Vendida</th><th>Total Venta</th>`;
                }

                tbody.innerHTML = ventasFiltradas.map(venta => `
                    <tr>
                        <td>${venta.fecha}</td>
                        ${allProductsMode ? `<td>${venta.producto_nombre}</td>` : ''}
                        <td>${venta.numero_pedido}</td>
                        <td>${venta.cliente}</td>
                        <td>${venta.cantidad}</td>
                        <td>S/ ${venta.total.toFixed(2)}</td>
                    </tr>
                `).join('');

            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="5" class="error-info">${error.message}</td></tr>`;
            }
        }
        
        async function generarReporteCompras() {
            const fechaInicio = document.getElementById('reporteComprasFechaInicio').value;
            const fechaFin = document.getElementById('reporteComprasFechaFin').value;
            const tbody = document.getElementById('reporteComprasTableBody');

            if (!fechaInicio || !fechaFin) {
                alert("Por favor, selecciona un rango de fechas.");
                return;
            }

            tbody.innerHTML = `<tr><td colspan="6" class="loading">Generando reporte...</td></tr>`;

            const fechaFinCompleta = new Date(fechaFin);
            fechaFinCompleta.setHours(23, 59, 59, 999);
            
            try {
                const { data, error } = await supabaseClient
                    .from('movimientos_inventario51')
                    .select('*, productos51(nombre)')
                    .eq('tipo_movimiento', 'INGRESO_COMPRA')
                    .gte('fecha_movimiento', new Date(fechaInicio).toISOString())
                    .lte('fecha_movimiento', fechaFinCompleta.toISOString())
                    .order('fecha_movimiento', { ascending: false });
                
                if (error) throw error;
                
                if(data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 2rem;">No se encontraron compras en el per√≠odo seleccionado.</td></tr>`;
                    return;
                }
                
                tbody.innerHTML = data.map(item => `
                    <tr>
                        <td>${new Date(item.fecha_movimiento).toLocaleString()}</td>
                        <td>${item.productos51.nombre}</td>
                        <td>${item.cantidad}</td>
                        <td>${item.referencia_id || 'N/A'}</td>
                        <td>${item.proveedor || 'N/A'}</td>
                        <td>${item.usuario_email || 'Sistema'}</td>
                    </tr>
                `).join('');
                
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="6" class="error-info">${error.message}</td></tr>`;
            }
        }

        function exportarReporteExcel() {
            if (datosReporteActual.length === 0) {
                alert("No hay datos para exportar. Primero genera un reporte en la pesta√±a 'Resumen de Ventas'.");
                return;
            }
            
            const datosParaExportar = datosReporteActual.map(item => ({
                "N¬∞ Pedido": item.numero_pedido,
                "Fecha": item.fecha,
                "Cliente": item.cliente,
                "Producto": item.producto,
                "Cantidad": item.cantidad,
                "Total Venta (S/)": item.total_venta.toFixed(2),
                "Costo Total (S/)": item.costo_total.toFixed(2),
                "Ganancia (S/)": item.ganancia.toFixed(2)
            }));
            
            const ws = XLSX.utils.json_to_sheet(datosParaExportar);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Reporte de Ventas");
            
            const fechaInicio = document.getElementById('reporteFechaInicio').value;
            const fechaFin = document.getElementById('reporteFechaFin').value;
            XLSX.writeFile(wb, `Reporte_Ventas_${fechaInicio}_a_${fechaFin}.xlsx`);
            mostrarNotificacion('üìä Reporte de Excel (.xlsx) descargado.');
        }


        function mostrarNotificacion(mensaje) {
            const notif = document.createElement('div');
            notif.textContent = mensaje;
            notif.style.cssText = `position: fixed; top: 100px; right: 20px; background: var(--dark); color: white; padding: 1rem 2rem; border-radius: 10px; box-shadow: var(--shadow-lg); z-index: 10000; font-weight: 600; animation: fadeInOut 3s ease-in-out forwards;`;
            const style = document.createElement('style');
            style.id = 'notif-style';
            if (!document.getElementById('notif-style')) {
                style.innerHTML = `@keyframes fadeInOut { 0% { opacity: 0; transform: translateY(-20px); } 10% { opacity: 1; transform: translateY(0); } 90% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-20px); } }`;
                document.head.appendChild(style);
            }
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        window.onclick = function(event) {
            if (event.target == document.getElementById('cartModal')) cerrarCarrito();
            if (event.target == document.getElementById('productoModal')) cerrarModalProducto();
            if (event.target == document.getElementById('categoriaModal')) cerrarModalCategoria();
            if (event.target == document.getElementById('pedidoModal')) cerrarModalPedido();
            if (event.target == document.getElementById('mapModal')) cerrarModalMapa();
            if (event.target == document.getElementById('detalleProductoModal')) cerrarModalDetalleProducto();
            if (event.target == document.getElementById('ingresoStockModal')) cerrarModalIngresoStock();
        }

        inicializarSupabase();
    </script>
</body>
</html>